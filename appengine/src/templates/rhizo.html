<!DOCTYPE html>
<html>
  <head>
    <title>Rhizosphere</title>

    <!-- Google services integration (e.g. GViz) -->
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>

    <!-- AppEngine channels -->
    {% if use_channels %}
      <script src='/_ah/channel/jsapi'></script>
    {% endif %}

    <!-- Rhizosphere libraries and styles -->
    {% include "rhizo_head.html" %}
  </head>
  <body>
    <div id="rhizo-pangea" style="position: absolute; top: 0; bottom: 0; right: 0; left: 0;">
    </div>

    <script type="text/javascript" charset="utf-8">
      // Force GViz to load early on, as otherwise the loading won't happen
      // if started inside the bootstrapper (I suspect because the bootstrapper
      // is itself included inside the JQuery ready() function).
      // This is reproducible in FF3.5 and Safari4 on Mac.
      //
      // Note that I suspect this may cause a possible race condition, since in
      // the bootstrapper we might be using GViz objects before the loading is
      // completed (aka, we don't wait the callback to be invoked).
      if (typeof google != 'undefined') {
        google.load('visualization', '1');
        google.setOnLoadCallback(function() {});
      }

      $(document).ready(function() {
        {% if use_channels %}
          // TODO(battlehorse): Broadcasting should rely on capabilities to
          // decide whether to activate itself or not, rather than URL
          // experimental parameters.
          rhizo.ui.component.templates['broadcast'] = function(project, options) {
            var template;
            if (project.gui().isSmall() || project.gui().isMobile()) {
              template = new rhizo.ui.component.BottomTemplate(
                  project, options, 'bottom');
              template.addtoBottomBar(new rhizo.broadcast.BaseComponent(
                  project, options));
            } else {
              template = new rhizo.ui.component.StandardTemplate(
                  project, options, 'default');
              template.addtoLeftBar(new rhizo.broadcast.BaseComponent(
                  project, options));
            }
            return template;
          };
        {% endif %}

        var options = {
          allowConfigFromUrl: true
          {% if use_channels %}
            ,forceTemplate: 'broadcast'
          {% else %}
            {% if forceTemplate %}
            ,forceTemplate: '{{forceTemplate}}'
            {% endif %}
          {% endif %}
          {% if forcePlatform %}
          ,forcePlatform: '{{forcePlatform}}'
          {% endif %}
          {% if forceDevice %}
          ,forceDevice: '{{forceDevice}}'
          {% endif %}
        };
        var bootstrapper = new rhizo.bootstrap.Bootstrap(
            $('#rhizo-pangea'), options);
        bootstrapper.prepareAndDeploy();
      });
    </script>
    {% include "ga.html" %}
  </body>
</html>
