/*

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2010 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2010 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2010 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2010 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2009 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2010 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2008 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2010 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2010 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 Copyright 2009 The Rhizosphere Authors. All Rights Reserved.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
function namespace(a){a=a.split(".");for(var b=window,c=0;c<a.length;c++){if(typeof b[a[c]]=="undefined")b[a[c]]={};b=b[a[c]]}}namespace("rhizo");rhizo.inherits=function(a,b){function c(){}c.prototype=b.prototype;a.prototype=new c;a.prototype.constructor=a};namespace("rhizo.util");rhizo.util.LOG_E_10=Math.log(10);rhizo.util.log10_=function(a){return Math.log(a)/rhizo.util.LOG_E_10};
rhizo.util.orderOfMagnitude=function(a){if(a==0)return Number.NaN;return Math.floor(Math.round(rhizo.util.log10_(Math.abs(a))*100)/100)};rhizo.util.parseUri=function(a){var b=rhizo.util.parseUri.options_;a=b.parser[b.strictMode?"strict":"loose"].exec(a);for(var c={},d=14;d--;)c[b.key[d]]=a[d]||"";c[b.q.name]={};c[b.key[12]].replace(b.q.parser,function(e,f,g){if(f)c[b.q.name][f]=g});return c};
rhizo.util.parseUri.options_={strictMode:false,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};
rhizo.util.urlParams=function(){return rhizo.util.parseUri(document.location.href).queryKey};rhizo.util.buildUrl=function(a,b){var c=a||document.location.href;if(!b)return c;c=rhizo.util.parseUri(c);var d=[c.protocol,"://",c.authority,c.path,"?",c.query];for(var e in b){d.push("&");d.push(e);d.push("=");d.push(encodeURIComponent(b[e]))}if(c.anchor.length>0){d.push("#");d.push(c.anchor)}return d.join("")};
rhizo.util.escapeSelectorToken=function(a){return a.replace(rhizo.util.escapeSelectorToken.regexp_,"\\$1")};rhizo.util.escapeSelectorToken.regexp_=RegExp("([!\"#\\$%&'\\(\\)\\*\\+,\\.\\/:;<=>?@\\[\\\\\\]\\^\\{\\|\\}\\~])","g");namespace("rhizo.jquery");rhizo.jquery.init=function(a,b,c){rhizo.jquery.initAnimations_(a,b);c&&rhizo.jquery.initMouseWheel_()};
rhizo.jquery.initAnimations_=function(a,b){if(!$.support.greyOut){$.extend($.support,{greyOut:true});(function(c){b?c.fn.extend({move:function(d,e,f){a.noFx?c(this).css(jQuery.extend({top:d,left:e},f)):c(this).animate(jQuery.extend({top:d,left:e},f),{duration:400,queue:false})},fadeIn:function(){c(this).stop(true,true);a.noFx?c(this).css({visibility:"visible",opacity:1}):c(this).css("visibility","visible").animate({opacity:1},400)},fadeOut:function(d){c(this).stop(true,true);if(a.noFx){c(this).css({visibility:"hidden",
opacity:0});d&&d.apply(this)}else c(this).animate({opacity:0},{duration:400,complete:function(){c(this).css("visibility","hidden");d&&d.apply(this)}})},greyOut:function(){c(this).stop(true,true);a.noFx?c(this).css({visibility:"visible",opacity:0.2}):c(this).css("visibility","visible").animate({opacity:0.2},400)}}):c.fn.extend({move:function(d,e,f){c(this).css(jQuery.extend({top:d,left:e},f))},fadeIn:function(){c(this).css({visibility:"visible",opacity:1})},fadeOut:function(d){c(this).css({visibility:"hidden",
opacity:0});d&&d.apply(this)},greyOut:function(){c(this).css("opacity",0.2)}});c.fn.fadeTo=function(d){if(d==rhizo.ui.Visibility.HIDDEN)this.fadeOut();else d==rhizo.ui.Visibility.VISIBLE?this.fadeIn():this.greyOut()}})(jQuery)}};
rhizo.jquery.initMouseWheel_=function(){if(!$.support.mouseWheel){$.extend($.support,{mouseWheel:true});(function(a){function b(f){var g=f||window.event,h=[].slice.call(arguments,1),i=g.timeStamp||(new Date).getTime();if(i-d<e)return false;d=i;var j=i=0;if(a.browser.webkit){i=g.wheelDeltaX;j=g.wheelDeltaY}else if(a.browser.mozilla)if(g.axis!==undefined&&g.axis===g.HORIZONTAL_AXIS)i=-g.detail;else j=-g.detail;else j=g.wheelDelta;i=i>0?1:i<0?-1:0;j=j>0?1:j<0?-1:0;f=a.event.fix(g);f.type="mousewheel";
h.unshift(f,i,j);return a.event.handle.apply(this,h)}var c=["DOMMouseScroll","mousewheel"],d=0,e=30;a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var f=c.length;f;)this.addEventListener(c[--f],b,false);else this.onmousewheel=b},teardown:function(){if(this.removeEventListener)for(var f=c.length;f;)this.removeEventListener(c[--f],b,false);else this.onmousewheel=null}};a.fn.extend({mousewheel:function(f){return f?this.bind("mousewheel",f):this.trigger("mousewheel")},unmousewheel:function(f){return this.unbind("mousewheel",
f)}})})(jQuery)}};namespace("rhizo.ui");rhizo.ui.toHumanLabel=function(a){if(typeof a=="number"&&a!=0){var b=rhizo.util.orderOfMagnitude(a);if(b<0)return a.toFixed(-b);else if(b<3)return a;b=parseInt(b/3,10);var c=["","K","M","G","T","P","E","Z","Y"][b]||"";return(a/Math.pow(10,b*3)).toPrecision(3)+c}else return a};rhizo.ui.fadeAllRenderingsTo=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d].rendering().raw_());$(c).fadeTo(b)};rhizo.ui.eventToModel=function(a,b){return b.model($(a.currentTarget).data("id"))};
rhizo.ui.elementToModel=function(a,b){return b.model($(a).data("id"))};rhizo.ui.Visibility={HIDDEN:0,GREY:1,VISIBLE:2};rhizo.ui.RenderingOp={ARTIFACT:"artifact",MOVE:"move",RESIZE:"resize",STYLE:"style"};rhizo.ui.RenderingPipeline=function(a,b){this.project_=a;this.container_=b;this.renderingOps_={};this.artifacts_=[];this.artifactLayer_=$("<div />").css({visibility:"hidden",opacity:0}).appendTo(this.container_);this.backupEnabled_=true;this.backupManager_=new rhizo.ui.RenderingBackupManager};
rhizo.ui.RenderingPipeline.prototype.cleanup=function(){this.artifactLayer_.fadeOut(function(){$(this).remove()});this.artifactLayer_=$("<div />").css({visibility:"hidden",opacity:0}).appendTo(this.container_);this.artifacts_=[];this.renderingOps_={}};rhizo.ui.RenderingPipeline.prototype.backupManager=function(){return this.backupEnabled_?this.backupManager_:null};rhizo.ui.RenderingPipeline.prototype.setBackupEnabled=function(a){a||this.backupManager_.clear();this.backupEnabled_=a};
rhizo.ui.RenderingPipeline.prototype.backup_=function(a){if(this.backupEnabled_)return this.backupManager_.backup(a,this.project_.model(a).rendering());return false};rhizo.ui.RenderingPipeline.prototype.getModelOps_=function(a){a in this.renderingOps_||(this.renderingOps_[a]=[]);return this.renderingOps_[a]};
rhizo.ui.RenderingPipeline.prototype.move=function(a,b,c,d,e){var f=this.getModelOps_(a);b={op:rhizo.ui.RenderingOp.MOVE,top:b,left:c};if(d!==undefined&&e!==undefined){this.backup_(a);b.elevation={key:d,value:e}}f.push(b);return this};rhizo.ui.RenderingPipeline.prototype.resize=function(a,b,c){this.backup_(a);this.getModelOps_(a).push({op:rhizo.ui.RenderingOp.RESIZE,width:b,height:c});return this};
rhizo.ui.RenderingPipeline.prototype.style=function(a,b){this.backup_(a);this.getModelOps_(a).push({op:rhizo.ui.RenderingOp.STYLE,styleProps:b});return this};rhizo.ui.RenderingPipeline.prototype.artifact=function(a){this.artifactLayer_.append(a);return this};
rhizo.ui.RenderingPipeline.prototype.apply=function(){var a={top:Number.POSITIVE_INFINITY,left:Number.POSITIVE_INFINITY,width:0,height:0};for(var b in this.renderingOps_){for(var c=this.renderingOps_[b],d=c.length-1;d>=0;d--){var e=this.project_.model(b).rendering();switch(c[d].op){case rhizo.ui.RenderingOp.MOVE:e.move(c[d].top,c[d].left);c[d].elevation&&e.pushElevation(c[d].elevation.key,c[d].elevation.value);break;case rhizo.ui.RenderingOp.RESIZE:e.rescaleRendering(c[d].width,c[d].height);break;
case rhizo.ui.RenderingOp.STYLE:e.setNakedCss(c[d].styleProps);break;default:throw"Unrecognized rendering op: "+c[d].op;}}this.updateBoundingRectangleCorner_(e,a)}this.computeBoundingRectangleArea_(a);this.artifactLayer_.fadeIn();return a};rhizo.ui.RenderingPipeline.prototype.updateBoundingRectangleCorner_=function(a,b){var c=a.position();b.top=Math.min(c.top,b.top);b.left=Math.min(c.left,b.left)};
rhizo.ui.RenderingPipeline.prototype.computeBoundingRectangleArea_=function(a){for(var b in this.renderingOps_){var c=this.project_.model(b).rendering(),d=c.getDimensions();c=c.position();a.width=Math.max(a.width,d.width+c.left-a.left);a.height=Math.max(a.height,d.height+c.top-a.top)}};rhizo.ui.RenderingBackupManager=function(){this.renderingBackups_={};this.numBackups_=0};rhizo.ui.RenderingBackupManager.prototype.clear=function(){this.renderingBackups_={};this.numBackups_=0};
rhizo.ui.RenderingBackupManager.prototype.backup=function(a,b){if(!(a in this.renderingBackups_)){this.renderingBackups_[a]=new rhizo.ui.RenderingBackup(b);this.numBackups_++;return true}return false};rhizo.ui.RenderingBackupManager.prototype.removeBackup=function(a){if(a in this.renderingBackups_){delete this.renderingBackups_[a];this.numBackups_--}};
rhizo.ui.RenderingBackupManager.prototype.restore=function(a,b){if(this.numBackups_>0){for(var c={},d=0;d<a.length;d++)c[a[d].id]=true;d={};for(var e in this.renderingBackups_)e in c||(d[e]=true);this.restoreInternal_(d,true,true,true);b&&this.restoreInternal_(this.renderingBackups_,false,false,true)}};rhizo.ui.RenderingBackupManager.prototype.restoreAll=function(){this.restoreInternal_(this.renderingBackups_,true,true,true);this.renderingBackups_={};this.numBackups_=0};
rhizo.ui.RenderingBackupManager.prototype.restoreInternal_=function(a,b,c,d){for(var e in a){this.renderingBackups_[e].restore(b,c,d);if(b&&c&&d){delete this.renderingBackups_[e];this.numBackups_--}}};rhizo.ui.RenderingBackup=function(a){this.rendering_=a;this.originalDimensions_=jQuery.extend({},a.getDimensions());this.originalBackground_=a.nakedCss("background-color");this.originalElevation_=this.rendering_.cloneElevation()};
rhizo.ui.RenderingBackup.prototype.restore=function(a,b,c){c&&this.rendering_.setNakedCss({backgroundColor:this.originalBackground_},true);a&&this.rendering_.rescaleRendering(this.originalDimensions_.width,this.originalDimensions_.height);b&&this.rendering_.restoreElevation(this.originalElevation_)};rhizo.ui.Elevation=function(a){this.elevations_={};this.elevation_top_=0;this.elevation_offset_=a||0};
rhizo.ui.Elevation.prototype.clone=function(){var a=new rhizo.ui.Elevation;a.elevations_=$.extend({},this.elevations_);a.elevation_top_=this.elevation_top_;a.elevation_offset_=this.elevation_offset_;return a};rhizo.ui.Elevation.prototype.add=function(a,b){if(b<=0)return false;this.elevations_[a]=b;return this.recomputeTop_()};rhizo.ui.Elevation.prototype.remove=function(a){delete this.elevations_[a];return this.recomputeTop_()};
rhizo.ui.Elevation.prototype.top=function(){return this.elevation_top_+this.elevation_offset_};rhizo.ui.Elevation.prototype.empty=function(){return this.elevation_top_==0};rhizo.ui.Elevation.prototype.recomputeTop_=function(){var a=0;for(var b in this.elevations_)a=Math.max(a,this.elevations_[b]);if(a!=this.elevation_top_){this.elevation_top_=a;return true}return false};
rhizo.ui.Rendering=function(a,b,c,d){this.model_=a;this.id=a.id;this.raw_node_=b;this.naked_node_=b.children().get(0);this.raw_node_.data("id",a.id);this.renderer_=c;this.renderingHints_=d;this.rendererAttachListener_=this.rendererStyleChanger_=this.rendererRescaler_=this.rendererSizeChecker_=null;this.setRendererHelpers_();this.expanded_=this.expandable_=false;this.position_={};this.cacheDimensions_=false;this.cachedDimensions_={};this.mark_=null;this.visibility=rhizo.ui.Visibility.HIDDEN;this.elevation_=
new rhizo.ui.Elevation(50);this.modes_={};this.notifyAttach_(true)};
rhizo.ui.Rendering.prototype.setRendererHelpers_=function(){if(typeof this.renderer_.canRescaleTo=="function")this.rendererSizeChecker_=this.renderer_.canRescaleTo;if(typeof this.renderer_.rescale=="function")this.rendererRescaler_=this.renderer_.rescale;if(typeof this.renderer_.changeStyle=="function")this.rendererStyleChanger_=this.renderer_.changeStyle;if(typeof this.renderer_.onAttach=="function")this.rendererAttachListener_=this.renderer_.onAttach};rhizo.ui.Rendering.prototype.raw_=function(){return this.raw_node_.get(0)};
rhizo.ui.Rendering.prototype.notifyAttach_=function(a){this.rendererAttachListener_&&this.rendererAttachListener_(this.model_.unwrap(),this.naked_node_,a)};
rhizo.ui.Rendering.prototype.reRender_=function(){this.notifyAttach_(false);this.raw_node_.children(":not(.rhizo-expand-model)").remove();this.naked_node_=$(this.renderer_.render(this.model_.unwrap(),this.expanded_,this.renderingHints_)).get(0);this.raw_node_.toggleClass("rhizo-model-expanded",this.expanded_).css({width:"",height:""});this.expanded_?this.pushElevation("__expanded__",200):this.popElevation("__expanded__");this.raw_node_.append(this.naked_node_);this.notifyAttach_(true);this.refreshCachedDimensions_()};
rhizo.ui.Rendering.prototype.beforeDestroy=function(){this.notifyAttach_(false)};rhizo.ui.Rendering.prototype.move=function(a,b,c){c?this.raw_node_.css({top:a,left:b}):this.raw_node_.move(a,b);this.position_={top:a,left:b};return this};rhizo.ui.Rendering.prototype.moveToMark=function(a){this.mark_!==null&&this.move(this.mark_.top,this.mark_.left,a);return this};
rhizo.ui.Rendering.prototype.moveFromMark=function(a,b,c){this.mark_!=null?this.move(this.mark_.top+a,this.mark_.left+b,c):this.move(a,b,c);return this};rhizo.ui.Rendering.prototype.markPosition=function(){this.mark_={top:parseInt(this.raw_node_.css("top"),10),left:parseInt(this.raw_node_.css("left"),10)};return this};rhizo.ui.Rendering.prototype.unmarkPosition=function(){this.mark_=null;return this};
rhizo.ui.Rendering.prototype.distanceFromMark=function(a,b){return this.mark_!=null?{left:b-this.mark_.left,top:a-this.mark_.top}:null};rhizo.ui.Rendering.prototype.refreshPosition=function(){this.position_={top:parseInt(this.raw_node_.css("top"),10),left:parseInt(this.raw_node_.css("left"),10)};return this};rhizo.ui.Rendering.prototype.position=function(){return this.position_};rhizo.ui.Rendering.prototype.setSelected=function(a){a?this.raw_node_.addClass("ui-selected"):this.raw_node_.removeClass("ui-selected")};
rhizo.ui.Rendering.prototype.startDimensionCaching=function(){this.cacheDimensions_=true;this.refreshCachedDimensions_()};rhizo.ui.Rendering.prototype.refreshCachedDimensions_=function(){this.cachedDimensions_={width:this.raw_().offsetWidth,height:this.raw_().offsetHeight}};rhizo.ui.Rendering.prototype.getDimensions=function(){return this.cacheDimensions_?this.cachedDimensions_:{width:this.raw_().offsetWidth,height:this.raw_().offsetHeight}};
rhizo.ui.Rendering.prototype.startExpandable=function(a){if(this.expandableByModel_()){a.data("id",this.id);this.raw_node_.append(a);this.expandable_=true}};rhizo.ui.Rendering.prototype.expandableByModel_=function(){return typeof this.renderer_.expandableByModel=="function"?this.renderer_.expandableByModel(this.model_.unwrap(),this.renderingHints_):true};rhizo.ui.Rendering.prototype.setExpanded=function(a){if(!this.expandable_||this.expanded_==a)return this;this.expanded_=a;this.reRender_();return this};
rhizo.ui.Rendering.prototype.toggleExpanded=function(){this.expanded_=!this.expanded_;this.reRender_();return this};rhizo.ui.Rendering.prototype.modelChanged=function(){this.reRender_()};rhizo.ui.Rendering.prototype.pushElevation=function(a,b){this.elevation_.add(a,b)&&this.raw_node_.css("z-index",this.elevation_.top())};rhizo.ui.Rendering.prototype.popElevation=function(a){if(this.elevation_.remove(a))this.raw_node_.css("z-index",this.elevation_.empty()?"":this.elevation_.top())};
rhizo.ui.Rendering.prototype.cloneElevation=function(){return this.elevation_.clone()};rhizo.ui.Rendering.prototype.restoreElevation=function(a){this.elevation_=a;this.raw_node_.css("z-index",this.elevation_.empty()?"":this.elevation_.top())};rhizo.ui.Rendering.prototype.canRescaleTo=function(a,b,c){if(a<=2||b<=2){c&&c();return false}if(this.rendererSizeChecker_){a=this.rendererSizeChecker_(this.model_.unwrap(),this.naked_node_,a-2,b-2);!a&&c&&c();return a}return true};
rhizo.ui.Rendering.prototype.rescaleRendering=function(a,b){this.cachedDimensions_={width:a,height:b};this.raw_node_.width(a-2).height(b-2);this.rendererRescaler_&&this.rendererRescaler_(this.model_.unwrap(),this.naked_node_,a-2,b-2);return this};rhizo.ui.Rendering.prototype.setNakedCss=function(a,b){if(typeof a!="object")throw"setNakedCss() expects a map of properties.";this.rendererStyleChanger_?this.rendererStyleChanger_(this.model_.unwrap(),this.naked_node_,a,b):$(this.naked_node_).css(a)};
rhizo.ui.Rendering.prototype.nakedCss=function(a){if(typeof a!="string")throw"nakedCss() expects a string of the property to access.";return $(this.naked_node_).css(a)};rhizo.ui.Rendering.prototype.setMode=function(a){this.modes_[a]=true;return this};rhizo.ui.Rendering.prototype.removeMode=function(a){delete this.modes_[a];return this};rhizo.ui.Rendering.prototype.isMode=function(a){return!!this.modes_[a]};
rhizo.ui.SyntheticRendering=function(a){this.raw_node_=a;this.raw_node_.css("position","absolute");this.position_={};this.cacheDimensions_=true;this.cachedDimensions_={width:this.raw_node_.get(0).offsetWidth,height:this.raw_node_.get(0).offsetHeight};this.elevation_=new rhizo.ui.Elevation(parseInt(this.raw_node_.css("z-index"),10));this.rendererRescaler_=this.rendererSizeChecker_=null};rhizo.ui.SyntheticRendering.prototype.move=rhizo.ui.Rendering.prototype.move;
rhizo.ui.SyntheticRendering.prototype.pushElevation=rhizo.ui.Rendering.prototype.pushElevation;rhizo.ui.SyntheticRendering.prototype.popElevation=rhizo.ui.Rendering.prototype.popElevation;rhizo.ui.SyntheticRendering.prototype.canRescaleTo=rhizo.ui.Rendering.prototype.canRescaleTo;rhizo.ui.SyntheticRendering.prototype.rescaleRendering=rhizo.ui.Rendering.prototype.rescaleRendering;rhizo.ui.SyntheticRendering.prototype.getDimensions=rhizo.ui.Rendering.prototype.getDimensions;
rhizo.ui.RenderingBootstrap=function(a,b,c,d){this.renderer_=a;this.gui_=b;this.project_=c;this.logger_=c.logger();this.options_=d;this.renderings_=[]};
rhizo.ui.RenderingBootstrap.prototype.buildRenderings=function(a){for(var b=[],c=this.getDragHandleSelector_()!=null,d=0;d<a.length;d++)this.rawrender_(a[d],b,c);if(b.length==0){this.logger_.error("No renderings.");return false}typeof b[0]=="string"?this.buildFromStrings_(a,b):this.buildFromShells_(a,b);b=this.gui_.universe.find(".rhizo-model");if(!this.sanityCheck_(b,a.length))return false;this.decorateRenderings_(b);return true};rhizo.ui.RenderingBootstrap.prototype.renderings=function(){return this.renderings_};
rhizo.ui.RenderingBootstrap.prototype.rawrender_=function(a,b,c){a=this.renderer_.render(a.unwrap(),a.expanded,this.gui_.allRenderingHints());c="rhizo-model"+(c?"":" rhizo-drag-handle");if(typeof a=="string"){b.push('<div class="');b.push(c);b.push('">');b.push(a);b.push("</div>")}else{c=$("<div />",{"class":c});c.append(a);b.push(c)}};
rhizo.ui.RenderingBootstrap.prototype.buildFromStrings_=function(a,b){this.gui_.universe.append(b.join(""));this.gui_.universe.find(".rhizo-model").each(jQuery.proxy(function(c,d){var e=a[c],f=new rhizo.ui.Rendering(e,$(d),this.renderer_,this.gui_.allRenderingHints());e.setRendering(f);this.renderings_.push(f)},this))};
rhizo.ui.RenderingBootstrap.prototype.buildFromShells_=function(a,b){for(var c=0;c<a.length;c++){this.gui_.universe.append(b[c]);var d=new rhizo.ui.Rendering(a[c],b[c],this.renderer_,this.gui_.allRenderingHints());a[c].setRendering(d);this.renderings_.push(d)}};
rhizo.ui.RenderingBootstrap.prototype.sanityCheck_=function(a,b){if(a.length!=b||this.renderings_.length!=b){this.logger_.error("The number of renderings and models differ: "+a.length+"  (raw), "+this.renderings_.length+" (renderings), "+b+" (models).");return false}return true};
rhizo.ui.RenderingBootstrap.prototype.getDragHandleSelector_=function(){return typeof this.renderer_.dragHandle=="string"?this.renderer_.dragHandle:typeof this.renderer_.dragHandle=="function"?this.renderer_.dragHandle():null};rhizo.ui.RenderingBootstrap.prototype.decorateRenderings_=function(a){this.canCacheDimensions_()&&this.startDimensionCaching_();this.expandable_()&&this.startExpandable_(a);this.startClick_(a);window.setTimeout(jQuery.proxy(function(){this.startDraggable_(a)},this),100)};
rhizo.ui.RenderingBootstrap.prototype.canCacheDimensions_=function(){return!!this.renderer_.cacheDimensions||!!this.options_.cacheDimensions};rhizo.ui.RenderingBootstrap.prototype.startDimensionCaching_=function(){for(var a=this.renderings_.length-1;a>=0;a--)this.renderings_[a].startDimensionCaching()};
rhizo.ui.RenderingBootstrap.prototype.expandable_=function(){return typeof this.renderer_.expandable=="boolean"?this.renderer_.expandable:typeof this.renderer_.expandable=="function"?this.renderer_.expandable(this.gui_.allRenderingHints()):false};
rhizo.ui.RenderingBootstrap.prototype.startExpandable_=function(a){for(var b=$("<div />",{"class":"rhizo-expand-model rhizo-icon rhizo-maximize-icon",title:"Maximize"}),c=this.renderings_.length-1;c>=0;c--)this.renderings_[c].startExpandable(b.clone());a.hover(function(){$(this).children(".rhizo-expand-model").css("visibility","visible")},function(){$(this).children(".rhizo-expand-model").css("visibility","hidden")});$(".rhizo-expand-model",this.gui_.container).click(jQuery.proxy(function(d){rhizo.ui.eventToModel(d,
this.project_).rendering().toggleExpanded();return false},this))};rhizo.ui.RenderingBootstrap.prototype.startClick_=function(a){a.click(jQuery.proxy(function(b){var c=rhizo.ui.eventToModel(b,this.project_);if(c.rendering().isMode("__dragging__")){c.rendering().removeMode("__dragging__");return false}if(b.target.nodeName!="A"){if($(b.target).is(".rhizo-stop-propagation")||$(b.target).parents(".rhizo-stop-propagation").length>0)return false;this.project_.toggleSelect(c.id);return false}},this))};
rhizo.ui.RenderingBootstrap.prototype.startDraggable_=function(a){a.draggable({cursor:"pointer",handle:this.getDragHandleSelector_()||".rhizo-drag-handle",distance:3,addClasses:false,start:jQuery.proxy(function(b,c){var d=rhizo.ui.elementToModel(c.helper[0],this.project_);d.rendering().setMode("__dragging__").markPosition().pushElevation("__dragging__",1E4);if(this.project_.isSelected(d.id)){d=this.project_.allSelected();for(var e in d)this.project_.model(e).rendering().markPosition()}},this),drag:jQuery.proxy(function(b,
c){var d=rhizo.ui.elementToModel(c.helper[0],this.project_);if(this.project_.isSelected(d.id)){var e=d.rendering().distanceFromMark(c.position.top,c.position.left),f=this.project_.allSelected();for(var g in f)g!=d.id&&f[g].rendering().moveFromMark(e.top,e.left,true)}},this),stop:jQuery.proxy(function(b,c){var d=[],e=rhizo.ui.elementToModel(c.helper[0],this.project_);e.rendering().unmarkPosition().refreshPosition().popElevation("__dragging__");d.push({id:e.id,top:e.rendering().position().top,left:e.rendering().position().left});
if(this.project_.isSelected(e.id)){e=this.project_.allSelected();for(var f in e){d.push({id:f,top:e[f].rendering().position().top,left:e[f].rendering().position().left});e[f].rendering().unmarkPosition()}}this.project_.modelsMoved(d)},this),refreshPositions:false})};namespace("rhizo.keyboard");
rhizo.keyboard.Style={PADDING:5,KEY_HEIGHT:40,KEY_WIDTH:40,KEY_RADIUS:5,KEY_COLORS:{pressed:{fg:"#7aa5d6",text:"#7aa5d6",bg:"#e5ecf9"},hover:{fg:"#7aa5d6",text:"#7aa5d6",bg:"#fff"},base:{fg:"#555",text:"#555",bg:"#fff"}},KEY_FONT:"normal normal normal 22px sans-serif"};
rhizo.keyboard.Keyboard=function(a){this.container_=a;this.keys_=[];this.canvas_=$("<canvas />",{"class":"rhizo-keyboard"}).appendTo(a);this.canvas_.get(0).width=this.canvas_.width();this.canvas_.get(0).height=this.canvas_.height();this.ctx_=this.canvas_.get(0).getContext("2d");this.canvas_.css({left:($(window).width()-this.canvas_.width())/2,top:($(window).height()-this.canvas_.height())/2});this.canvas_.draggable();this.focusTarget_=null;this.ignoreBlur_=false;this.initEvents_();this.initKeys_()};
rhizo.keyboard.Keyboard.prototype.paint=function(){this.ctx_.clearRect(0,0,this.canvas_.get(0).width,this.canvas_.get(0).height);for(var a=0;a<this.keys_.length;a++)this.keys_[a].paint(this.ctx_)};rhizo.keyboard.Keyboard.prototype.getKeys=function(){return this.keys_};rhizo.keyboard.Keyboard.prototype.getFocusTarget=function(){return this.focusTarget_};
rhizo.keyboard.Keyboard.prototype.initEvents_=function(){$("input, textarea",this.container_).focus(jQuery.proxy(function(a){this.focusTarget_=a.target;this.canvas_.show();this.paint()},this)).blur(jQuery.proxy(function(){this.ignoreBlur_||this.canvas_.hide()},this));this.canvas_.mousemove(jQuery.proxy(function(a){for(var b=false,c=0;c<this.keys_.length;c++){var d=this.keys_[c].isInside(a.offsetX||a.layerX,a.offsetY||a.layerY);b=b||d;this.keys_[c].setHover(d)}this.canvas_.css("cursor",b?"pointer":
"move").draggable(b?"disable":"enable");this.paint()},this));this.canvas_.mousedown(jQuery.proxy(this.mousedown_,this));this.canvas_.mouseup(jQuery.proxy(function(){this.ignoreBlur_=false;for(var a=0;a<this.keys_.length;a++)this.keys_[a].isToggle()||this.keys_[a].setPressed(false);this.paint();$(this.focusTarget_).focus()},this))};
rhizo.keyboard.Keyboard.prototype.mousedown_=function(a){this.ignoreBlur_=true;for(var b=0;b<this.keys_.length;b++){var c=this.keys_[b].isInside(a.offsetX||a.layerX,a.offsetY||a.layerY);if(this.keys_[b].isToggle())if(c)this.keys_[b].setPressed(!this.keys_[b].isPressed());else this.keys_[b].isToggleReleasedByOtherKeys()&&this.keys_[b].isPressed()&&this.keys_[b].setPressed(false);else this.keys_[b].setPressed(c)}this.paint()};
rhizo.keyboard.Keyboard.prototype.initKeys_=function(){var a={enter:rhizo.keyboard.EnterKey,"delete":rhizo.keyboard.DeleteKey,tab:rhizo.keyboard.TabKey,caps:rhizo.keyboard.CapsKey,shift:rhizo.keyboard.ShiftKey,reset:rhizo.keyboard.ResetKey,space:rhizo.keyboard.SpaceKey},b=[];b.push(["`","1","2","3","4","5","6","7","8","9","0","-","=","delete"]);b.push(["tab","q","w","e","r","t","y","u","i","o","p","[","]","\\"]);b.push(["caps","a","s","d","f","g","h","j","k","l",";","'","enter"]);b.push(["shift",
"z","x","c","v","b","n","m",",",".","/","reset"]);b.push(["space"]);for(var c=rhizo.keyboard.Style.PADDING,d=c,e=0;e<b.length;e++){for(var f=c,g=0;g<b[e].length;g++){var h=b[e][g];h=new (h in a?a[h]:rhizo.keyboard.Key)(b[e][g],f,d,this);this.keys_.push(h);f+=h.width()+c}d+=c+rhizo.keyboard.Style.KEY_HEIGHT}};
rhizo.keyboard.Key=function(a,b,c,d){this.key_=this.label_=a;this.kx_=b;this.ky_=c;this.keyboard_=d;this.radius_=rhizo.keyboard.Style.KEY_RADIUS;this.height_=rhizo.keyboard.Style.KEY_HEIGHT;this.width_=rhizo.keyboard.Style.KEY_WIDTH;this.hover_=this.pressed_=false;this.canAutofire_=true;this.autofireIntervalId_=null;this.colors_={}};rhizo.keyboard.Key.prototype.width=function(){return this.width_};rhizo.keyboard.Key.prototype.isToggle=function(){return false};
rhizo.keyboard.Key.prototype.paint=function(a){this.setStyles_(a);this.paintRoundedRect_(a);this.paintKey_(a)};rhizo.keyboard.Key.prototype.setStyles_=function(){this.colors_=this.pressed_?rhizo.keyboard.Style.KEY_COLORS.pressed:this.hover_?rhizo.keyboard.Style.KEY_COLORS.hover:rhizo.keyboard.Style.KEY_COLORS.base};
rhizo.keyboard.Key.prototype.paintRoundedRect_=function(a){a.beginPath();a.moveTo(this.kx_,this.ky_+this.radius_);a.lineTo(this.kx_,this.ky_+this.height_-this.radius_);a.quadraticCurveTo(this.kx_,this.ky_+this.height_,this.kx_+this.radius_,this.ky_+this.height_);a.lineTo(this.kx_+this.width()-this.radius_,this.ky_+this.height_);a.quadraticCurveTo(this.kx_+this.width(),this.ky_+this.height_,this.kx_+this.width(),this.ky_+this.height_-this.radius_);a.lineTo(this.kx_+this.width(),this.ky_+this.radius_);
a.quadraticCurveTo(this.kx_+this.width(),this.ky_,this.kx_+this.width()-this.radius_,this.ky_);a.lineTo(this.kx_+this.radius_,this.ky_);a.quadraticCurveTo(this.kx_,this.ky_,this.kx_,this.ky_+this.radius_);a.strokeStyle=this.colors_.fg;a.fillStyle=this.colors_.bg;a.fill();a.stroke()};
rhizo.keyboard.Key.prototype.paintKey_=function(a){a.fillStyle=this.colors_.text;a.font=rhizo.keyboard.Style.KEY_FONT;a.textBaseline="middle";a.textAlign="center";a.fillText(this.label_,this.kx_+this.width()/2,this.ky_+this.height_/2)};rhizo.keyboard.Key.prototype.isInside=function(a,b){return this.kx_<a&&this.kx_+this.width()>a&&this.ky_<b&&this.ky_+this.height_>b};rhizo.keyboard.Key.prototype.setHover=function(a){this.hover_=a};
rhizo.keyboard.Key.prototype.setPressed=function(a){(this.pressed_=a)&&this.modifyTarget_(this.keyboard_.getFocusTarget());if(this.canAutofire_)if(this.pressed_){if(this.autofireIntervalId_==null)this.autofireIntervalId_=window.setInterval(jQuery.proxy(this.setPressed,this),100,true)}else{window.clearInterval(this.autofireIntervalId_);this.autofireIntervalId_=null}};rhizo.keyboard.Key.prototype.isPressed=function(){return this.pressed_};
rhizo.keyboard.Key.prototype.setCaps=function(a){var b="abcdefghijklmnopqrstuvwxyz".toUpperCase(),c=a?"abcdefghijklmnopqrstuvwxyz`1234567890-=[]\\;',./":b+'~!@#$%^&*()_+{}|:"<>?';a=a?b+'~!@#$%^&*()_+{}|:"<>?':"abcdefghijklmnopqrstuvwxyz`1234567890-=[]\\;',./";for(b=0;b<c.length;b++)if(c[b]==this.label_){this.label_=a[b];this.key_=a[b];break}};
rhizo.keyboard.Key.prototype.modifyTarget_=function(a){var b=a.selectionStart,c=a.selectionEnd,d=$(a).val(),e="";if(c-b>0){e=d.substr(c);d=d.substr(0,b)}$(a).val(d+this.key_+e)};rhizo.keyboard.EnterKey=function(a,b,c,d){rhizo.keyboard.Key.call(this,a,b,c,d);this.width_=77;this.canAutofire_=false};rhizo.inherits(rhizo.keyboard.EnterKey,rhizo.keyboard.Key);rhizo.keyboard.EnterKey.prototype.modifyTarget_=function(a){$(a).change()};
rhizo.keyboard.TabKey=function(a,b,c,d){rhizo.keyboard.Key.call(this,a,b,c,d);this.width_=70;this.key_="\t"};rhizo.inherits(rhizo.keyboard.TabKey,rhizo.keyboard.Key);rhizo.keyboard.DeleteKey=function(a,b,c,d){rhizo.keyboard.Key.call(this,a,b,c,d);this.width_=70};rhizo.inherits(rhizo.keyboard.DeleteKey,rhizo.keyboard.Key);
rhizo.keyboard.DeleteKey.prototype.modifyTarget_=function(a){var b=a.selectionStart,c=a.selectionEnd,d=$(a).val();if(c-b>0)$(a).val(d.substr(0,b)+d.substr(c));else d.length>0&&$(a).val(d.substr(0,d.length-1))};rhizo.keyboard.CapsKey=function(a,b,c,d){rhizo.keyboard.Key.call(this,a,b,c,d);this.width_=80;this.canAutofire_=false};rhizo.inherits(rhizo.keyboard.CapsKey,rhizo.keyboard.Key);rhizo.keyboard.CapsKey.prototype.setPressed=function(a){this.pressed_=a;a=this.keyboard_.getKeys();for(var b=0;b<a.length;b++)a[b].setCaps(this.pressed_)};
rhizo.keyboard.CapsKey.prototype.isToggle=function(){return true};rhizo.keyboard.CapsKey.prototype.isToggleReleasedByOtherKeys=function(){return false};rhizo.keyboard.ShiftKey=function(a,b,c,d){rhizo.keyboard.CapsKey.call(this,a,b,c,d);this.width_=97};rhizo.inherits(rhizo.keyboard.ShiftKey,rhizo.keyboard.CapsKey);rhizo.keyboard.ShiftKey.prototype.isToggleReleasedByOtherKeys=function(){return true};
rhizo.keyboard.ResetKey=function(a,b,c,d){rhizo.keyboard.Key.call(this,a,b,c,d);this.width_=105;this.canAutofire_=false};rhizo.inherits(rhizo.keyboard.ResetKey,rhizo.keyboard.Key);rhizo.keyboard.ResetKey.prototype.modifyTarget_=function(a){$(a).val("").change()};rhizo.keyboard.SpaceKey=function(a,b,c,d){rhizo.keyboard.Key.call(this,a,b,c,d);this.width_=660;this.key_=" "};rhizo.inherits(rhizo.keyboard.SpaceKey,rhizo.keyboard.Key);namespace("rhizo.meta");
rhizo.meta.StringKind=function(){this.input_=null};rhizo.meta.StringKind.prototype.renderFilter=function(a,b,c){this.input_=$("<input type='text' />");$(this.input_).change(function(){a.filter(c,$(this).val().length>0?$(this).val():null)});return $("<div class='rhizo-filter' />").append(b.label+": ").append($(this.input_))};rhizo.meta.StringKind.prototype.setFilterValue=function(a){this.input_.val(a||"")};
rhizo.meta.StringKind.prototype.survivesFilter=function(a,b){return a!=""&&(b||"").toLowerCase().indexOf(a.toLowerCase())!=-1};rhizo.meta.StringKind.prototype.cluster=function(a){if(a===null||typeof a=="undefined")a="";return{key:a.toString().toUpperCase().charAt(0),label:a.toString().toUpperCase().charAt(0)}};rhizo.meta.StringKind.prototype.isNumeric=function(){return false};rhizo.meta.NumberKind=function(){rhizo.meta.StringKind.call(this)};rhizo.inherits(rhizo.meta.NumberKind,rhizo.meta.StringKind);
rhizo.meta.NumberKind.prototype.survivesFilter=function(a,b){var c=parseInt(a,10);return isNaN(c)?true:c==b};rhizo.meta.NumberKind.prototype.compare=function(a,b){return parseInt(a,10)-parseInt(b,10)};
rhizo.meta.NumberKind.prototype.cluster=function(a){var b=parseInt(a,10);if(isNaN(b))return{key:"-",label:"-"};if(parseFloat(a)<=10)return{key:b,label:b.toString()};for(var c=0;b>=10;){b=parseInt(b/10);c++}c=Math.pow(10,c);b=parseInt(a/c,10)*c;a=parseInt(a/c+1,10)*c;return{key:b,label:b.toString()+" - "+a.toString()}};rhizo.meta.NumberKind.prototype.isNumeric=function(){return true};
rhizo.meta.DateKind=function(a){this.monthMap_=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];this.clusterby_=a||"y";if(this.clusterby_!="y"&&this.clusterby_!="m"&&this.clusterby_!="d")this.clusterby_="y";this.day_=this.month_=this.year_=null};
rhizo.meta.DateKind.prototype.renderFilter=function(a,b,c){this.year_=$("<select style='vertical-align:top' />");this.year_.append("<option value='yyyy'>yyyy</option>");for(var d=b.minYear;d<=b.maxYear;d++)this.year_.append("<option value='"+d+"'>"+d+"</option>");this.month_=$("<select style='vertical-align:top' />");this.month_.append("<option value='mm'>mm</option>");for(d=0;d<this.monthMap_.length;d++)this.month_.append("<option value='"+d+"'>"+this.monthMap_[d]+"</option>");this.day_=$("<select style='vertical-align:top' />");
this.day_.append("<option value='dd'>dd</option>");for(d=1;d<=31;d++)this.day_.append("<option value='"+d+"'>"+d+"</option>");$(this.year_).add($(this.month_)).add($(this.day_)).change(jQuery.proxy(function(){var e=$(this.year_).val(),f=$(this.month_).val(),g=$(this.day_).val();e=="yyyy"&&f=="mm"&&g=="dd"?a.filter(c,null):a.filter(c,[e!="yyyy"?e:undefined,f!="mm"?f:undefined,g!="dd"?g:undefined])},this));return $("<div class='rhizo-filter' />").append(b.label+": ").append($(this.year_)).append(" - ").append($(this.month_)).append(" - ").append($(this.day_))};
rhizo.meta.DateKind.prototype.setFilterValue=function(a){a=a||[undefined,undefined,undefined];this.year_.val(a[0]||"yyyy");this.month_.val(a[1]||"mm");this.day_.val(a[2]||"dd")};rhizo.meta.DateKind.prototype.survivesFilter=function(a,b){var c=parseInt(a[0],10),d=parseInt(a[1],10),e=parseInt(a[2],10);if(!b)return isNaN(c)&&isNaN(d)&&isNaN(e);return(isNaN(c)||b.getFullYear()==c)&&(isNaN(d)||b.getMonth()==d)&&(isNaN(e)||b.getDate()==e)};
rhizo.meta.DateKind.prototype.cluster=function(a){if(!a)return{key:"Undefined date",label:"Undefined date"};return this.clusterby_=="y"?{key:a.getFullYear()+"-00-01",label:a.getFullYear()}:this.clusterby_=="m"?{key:a.getFullYear()+"-"+this.addZero_(a.getMonth())+"-01",label:a.getFullYear()+"-"+this.monthMap_[a.getMonth()]}:{key:a.getFullYear()+"-"+this.addZero_(a.getMonth())+"-"+this.addZero_(a.getDate()),label:a.getFullYear()+"-"+this.monthMap_[a.getMonth()]+"-"+a.getDate()}};
rhizo.meta.DateKind.prototype.isNumeric=function(){return false};rhizo.meta.DateKind.prototype.addZero_=function(a){a=a.toString();if(a.length==1)a="0"+a;return a};rhizo.meta.RangeKind=function(){this.metadataMax_=this.metadataMin_=this.maxLabel_=this.minLabel_=this.slider_=null};
rhizo.meta.RangeKind.prototype.renderFilter=function(a,b,c){this.slider_=$("<div class='rhizo-slider' />");this.minLabel_=$("<span />",{"class":"rhizo-slider-label"}).text(this.toHumanLabel_(b.min));this.maxLabel_=$("<span />",{"class":"rhizo-slider-label"}).text(this.toHumanLabel_(b.max));this.metadataMin_=b.min;this.metadataMax_=b.max;var d=this.toFilterScale(b.min),e=this.toFilterScale(b.max),f;if(b.stepping)f=this.toFilterScale(b.stepping);var g=jQuery.proxy(function(i,j){if(j.values[0]!=d){this.minLabel_.text(this.toHumanLabel_(this.toModelScale(j.values[0]))).addClass("rhizo-slider-moving");
this.maxLabel_.removeClass("rhizo-slider-moving")}if(j.values[1]!=e){this.maxLabel_.text(this.toHumanLabel_(this.toModelScale(j.values[1]))).addClass("rhizo-slider-moving");this.minLabel_.removeClass("rhizo-slider-moving")}},this),h=jQuery.proxy(function(i,j){var k=Math.max(this.toModelScale(j.values[0]),b.min),n=Math.min(this.toModelScale(j.values[1]),b.max);this.minLabel_.text(this.toHumanLabel_(k)).removeClass("rhizo-slider-moving");this.maxLabel_.text(this.toHumanLabel_(n)).removeClass("rhizo-slider-moving");
k!=this.metadataMin_||n!=this.metadataMax_?a.filter(c,{min:k,max:n}):a.filter(c,null)},this);$(this.slider_).slider({stepping:f,steps:b.steps,range:true,min:d,max:e,slide:g,stop:h,orientation:"horizontal",values:[d,e]});return $("<div class='rhizo-filter' />").append(b.label+": ").append($(this.minLabel_)).append(" to ").append($(this.maxLabel_)).append($(this.slider_))};
rhizo.meta.RangeKind.prototype.setFilterValue=function(a){a={min:a?this.clamp_(a.min):this.metadataMin_,max:a?this.clamp_(a.max):this.metadataMax_};this.minLabel_.text(this.toHumanLabel_(a.min));this.maxLabel_.text(this.toHumanLabel_(a.max));this.slider_.slider("values",[this.toFilterScale(a.min),this.toFilterScale(a.max)])};rhizo.meta.RangeKind.prototype.clamp_=function(a){return Math.min(this.metadataMax_,Math.max(this.metadataMin_,a))};
rhizo.meta.RangeKind.prototype.survivesFilter=function(a,b){return b>=a.min&&b<=a.max};rhizo.meta.RangeKind.prototype.compare=rhizo.meta.NumberKind.prototype.compare;rhizo.meta.RangeKind.prototype.cluster=rhizo.meta.NumberKind.prototype.cluster;rhizo.meta.RangeKind.prototype.isNumeric=rhizo.meta.NumberKind.prototype.isNumeric;rhizo.meta.RangeKind.prototype.toModelScale=function(a){return a};rhizo.meta.RangeKind.prototype.toFilterScale=function(a){return a};
rhizo.meta.RangeKind.prototype.toHumanLabel_=function(a){return a};rhizo.meta.BooleanKind=function(){this.check_=null};
rhizo.meta.BooleanKind.prototype.renderFilter=function(a,b,c){this.check_=$("<select />");this.check_.append("<option value=''>-</option>");this.check_.append("<option value='true'>Yes</option>");this.check_.append("<option value='false'>No</option>");$(this.check_).change(function(){a.filter(c,$(this).val().length>0?$(this).val():null)});return $("<div class='rhizo-filter' />").append(b.label+": ").append($(this.check_))};
rhizo.meta.BooleanKind.prototype.setFilterValue=function(a){this.check_.val(a||"")};rhizo.meta.BooleanKind.prototype.survivesFilter=function(a,b){return a=="true"==b};rhizo.meta.BooleanKind.prototype.compare=function(a,b){return a?b?0:-1:b?1:0};rhizo.meta.BooleanKind.prototype.isNumeric=function(){return false};rhizo.meta.CategoryKind=function(){this.categories_=null;this.multiple_=false};
rhizo.meta.CategoryKind.prototype.renderFilter=function(a,b,c){this.multiple_=!!b.multiple;this.categories_=$("<select "+(b.multiple?'multiple size="4" ':"")+" style='vertical-align:top' />");this.categories_.append("<option value=''>-</option>");for(var d=0;d<b.categories.length;d++)this.categories_.append("<option value='"+b.categories[d]+"'>"+b.categories[d]+"</option>");$(this.categories_).change(function(){var e=[];if(b.multiple)e=$.grep($(this).val(),function(f){return f!=""});else if($(this).val().length>
0)e=[$(this).val()];if(e.length==0)e=null;a.filter(c,e)});return $("<div class='rhizo-filter' />").append(b.label+": ").append($(this.categories_))};rhizo.meta.CategoryKind.prototype.setFilterValue=function(a){this.categories_.val(a||(this.multiple_?[]:""))};rhizo.meta.CategoryKind.prototype.survivesFilter=function(a,b){$.isArray(b)||(b=[b]);for(var c=false,d=0;d<a.length;d++)if(b&&b.indexOf(a[d])!=-1){c=true;break}return c};
rhizo.meta.CategoryKind.prototype.cluster=function(a){if(!a)return{key:"Nothing",label:"Nothing"};return{key:a.length==0?"Nothing":a.toString(),label:a.length==0?"Nothing":a.toString()}};rhizo.meta.CategoryKind.prototype.compare=function(a,b){return(a?a.length:0)-(b?b.length:0)};rhizo.meta.CategoryKind.prototype.isNumeric=function(){return false};
rhizo.meta.sortBy=function(a,b,c){return function(d,e){var f=d.unwrap(),g=e.unwrap(),h=c?-1:1;return b.compare?b.compare(f[a],g[a])*h:(f[a]<g[a]?-1:f[a]>g[a]?1:0)*h}};rhizo.meta.sortByKind=function(a,b){return function(c,d){var e=b?-1:1;return a.compare?a.compare(c,d)*e:(c<d?-1:c>d?1:0)*e}};rhizo.meta.objectify=function(a){return typeof a=="function"?a():a};
rhizo.meta.Kind={STRING:function(){return new rhizo.meta.StringKind},NUMBER:function(){return new rhizo.meta.NumberKind},DATE:function(){return new rhizo.meta.DateKind},RANGE:function(){return new rhizo.meta.RangeKind},BOOLEAN:function(){return new rhizo.meta.BooleanKind},CATEGORY:function(){return new rhizo.meta.CategoryKind}};namespace("rhizo.state");rhizo.state.TYPE="__rhizo_state__";rhizo.state.Facets={LAYOUT:"layout",SELECTION_FILTER:"selection",FILTER_PREFIX:"filter_"};
rhizo.state.Bindings={PROJECT:"project",HISTORY:"history"};rhizo.state.MasterOverlord=function(){this.state_={type:rhizo.state.TYPE,uuids:{},delta:{ts:null,uuid:null,facet:null,facetState:null}};this.projectOverlords_={};this.initialStateOwner_=null};
rhizo.state.MasterOverlord.prototype.attachProject=function(a,b){var c=a.uuid(),d=new rhizo.state.ProjectOverlord(this,a,b);this.projectOverlords_[c]=d;if(c in this.state_.uuids){if(!this.initialStateOwner_)throw"Initial state owner is unknown, even though an initial state exists for: "+c;d.broadcast(this.initialStateOwner_,null);return true}return false};
rhizo.state.MasterOverlord.prototype.detachProject=function(a){a=a.uuid();if(a in this.projectOverlords_){this.projectOverlords_[a].removeAllBindings();delete this.projectOverlords_[a]}a in this.state_.uuids&&delete this.state_.uuids[a]};rhizo.state.MasterOverlord.prototype.projectOverlord=function(a){return this.projectOverlords_[a.uuid()]};rhizo.state.MasterOverlord.prototype.projectBinder=function(a){return this.projectOverlords_[a.uuid()].getProjectBinder()};
rhizo.state.MasterOverlord.prototype.state=function(){return this.state_};rhizo.state.MasterOverlord.prototype.setState=function(a){this.state_=a};rhizo.state.MasterOverlord.prototype.setInitialState=function(a,b,c){if(!c){var d=0;for(var e in this.state_.uuids)d++;if(d>0)return}this.initialStateOwner_=a;this.setState(b);for(e in this.state_.uuids)e in this.projectOverlords_&&this.projectOverlords_[e].broadcast(a,null,c)};
rhizo.state.MasterOverlord.prototype.pushDelta=function(a){this.state_.delta=a;a.uuid in this.state_.uuids||(this.state_.uuids[a.uuid]={});this.state_.uuids[a.uuid][a.facet]=a.facetState};
rhizo.state.ProjectOverlord=function(a,b,c){this.master_=a;this.uuid_=b.uuid();this.bindings_={};c.push(rhizo.state.Bindings.PROJECT);for(var d=0;d<c.length;d++){var e=c[d];switch(e){case rhizo.state.Bindings.PROJECT:a=new rhizo.state.ProjectStateBinder(this,b);this.bindings_[e]=a;break;case rhizo.state.Bindings.HISTORY:if(rhizo.state.getHistoryHelper()){a=new rhizo.state.HistoryStateBinder(this);this.bindings_[e]=a}break;default:throw"Unknown binding: "+e;}}};
rhizo.state.ProjectOverlord.prototype.getProjectBinder=function(){return this.bindings_[rhizo.state.Bindings.PROJECT]};rhizo.state.ProjectOverlord.prototype.uuid=function(){return this.uuid_};rhizo.state.ProjectOverlord.prototype.master=function(){return this.master_};rhizo.state.ProjectOverlord.prototype.addBinding=function(a){a.key()in this.bindings_||(this.bindings_[a.key()]=a);this.uuid_ in this.master_.state().uuids&&a.onTransition(null,this.master_.state())};
rhizo.state.ProjectOverlord.prototype.removeBinding=function(a){var b=this.bindings_[a];b.onRemove();delete this.bindings_[a];return b};rhizo.state.ProjectOverlord.prototype.removeAllBindings=function(){for(var a in this.bindings_)this.removeBinding(a)};rhizo.state.ProjectOverlord.prototype.transition=function(a,b,c,d){c?this.master_.setState(c):this.master_.pushDelta(b);this.broadcast(a,b,d)};
rhizo.state.ProjectOverlord.prototype.broadcast=function(a,b,c){for(var d in this.bindings_)d!=a&&this.bindings_[d].onTransition(b,this.master_.state(),c)};rhizo.state.StateBinder=function(a,b){this.overlord_=a;this.binderKey_=b};rhizo.state.StateBinder.prototype.key=function(){return this.binderKey_};rhizo.state.StateBinder.prototype.onTransition=function(){throw"Unimplemented StateBinder.onTransition";};
rhizo.state.StateBinder.prototype.makeDelta=function(a,b){return{ts:(new Date).getTime(),uuid:this.overlord_.uuid(),facet:a,facetState:b}};rhizo.state.StateBinder.prototype.onRemove=function(){};rhizo.state.ProjectStateBinder=function(a,b){rhizo.state.StateBinder.call(this,a,rhizo.state.Bindings.PROJECT);this.project_=b;this.removed_=false};rhizo.inherits(rhizo.state.ProjectStateBinder,rhizo.state.StateBinder);rhizo.state.ProjectStateBinder.prototype.onRemove=function(){this.removed_=true};
rhizo.state.ProjectStateBinder.prototype.onTransition=function(a,b){if(this.removed_)throw"ProjectStateBinder received a transition after being removed from overlord.";a?this.project_.stateChanged(a.facet,a.facetState):this.project_.setState(b.uuids[this.overlord_.uuid()])};
rhizo.state.ProjectStateBinder.prototype.pushLayoutChange=function(a,b,c){if(this.removed_)throw"ProjectStateBinder cannot issue transitions after removal from overlord";b=jQuery.extend({layoutName:a},b);a=!!c&&this.curLayoutHasPositions_();if(c)b.positions=this.mergePositions_(c);c=this.makeDelta(rhizo.state.Facets.LAYOUT,b);this.overlord_.transition(this.key(),c,null,a)};
rhizo.state.ProjectStateBinder.prototype.curLayoutHasPositions_=function(){var a=this.overlord_.master().state(),b=this.overlord_.uuid();return b in a.uuids&&rhizo.state.Facets.LAYOUT in a.uuids[b]&&!!a.uuids[b][rhizo.state.Facets.LAYOUT].positions};
rhizo.state.ProjectStateBinder.prototype.mergePositions_=function(a){for(var b={},c=a.length-1;c>=0;c--)b[a[c].id]=true;if(this.curLayoutHasPositions_()){var d=this.overlord_.master().state().uuids[this.overlord_.uuid()][rhizo.state.Facets.LAYOUT].positions||[];for(c=d.length-1;c>=0;c--)d[c].id in b||a.push(d[c])}return a};
rhizo.state.ProjectStateBinder.prototype.pushFilterSelectionChange=function(a){if(this.removed_)throw"ProjectStateBinder cannot issue transitions after removal from overlord";a=this.makeDelta(rhizo.state.Facets.SELECTION_FILTER,a);this.overlord_.transition(this.key(),a)};
rhizo.state.ProjectStateBinder.prototype.pushFilterChange=function(a,b){if(this.removed_)throw"ProjectStateBinder cannot issue transitions after removal from overlord";var c=this.makeDelta(rhizo.state.Facets.FILTER_PREFIX+a,b);this.overlord_.transition(this.key(),c)};
rhizo.state.HistoryStateBinder=function(a){rhizo.state.StateBinder.call(this,a,rhizo.state.Bindings.HISTORY);rhizo.state.getHistoryHelper().addListener(this.overlord_.uuid(),jQuery.proxy(function(b,c){this.overlord_.transition(this.key(),b,c)},this))};rhizo.inherits(rhizo.state.HistoryStateBinder,rhizo.state.StateBinder);rhizo.state.HistoryStateBinder.prototype.onTransition=function(a,b,c){rhizo.state.getHistoryHelper().sync(b,c)};rhizo.state.HistoryStateBinder.prototype.onRemove=function(){rhizo.state.getHistoryHelper().removeListener(this.overlord_.uuid())};
rhizo.state.HistoryHelper=function(a){this.master_=a;this.listeners_={};this.initialStateReceived_=false;$(window).bind("popstate",jQuery.proxy(this.historyChange_,this))};rhizo.state.HistoryHelper.prototype.addListener=function(a,b){this.listeners_[a]=b};rhizo.state.HistoryHelper.prototype.removeListener=function(a){a in this.listeners_&&delete this.listeners_[a]};
rhizo.state.HistoryHelper.prototype.sync=function(a,b){this.initialStateReceived_=true;b?window.history.replaceState(a,""):window.history.pushState(a,"")};
rhizo.state.HistoryHelper.prototype.historyChange_=function(a){if(this.initialStateReceived_){var b=a.originalEvent.state;if(b){if(!this.isRhizoState_(b))return;if(this.master_.state().delta.ts==b.delta.ts)return;a=this.diff_(this.master_.state(),b)}else a={ts:(new Date).getTime(),uuid:this.master_.state().delta.uuid,facet:this.master_.state().delta.facet,facetState:null};if(a.uuid in this.listeners_)this.listeners_[a.uuid](a,b);else b?this.master_.setState(b):this.master_.pushDelta(a)}else{this.initialStateReceived_=
true;(a=a.originalEvent.state)&&this.isRhizoState_(a)&&this.master_.setInitialState(rhizo.state.Bindings.HISTORY,a)}};rhizo.state.HistoryHelper.prototype.isRhizoState_=function(a){return a.type==rhizo.state.TYPE};rhizo.state.HistoryHelper.prototype.diff_=function(a,b){if(b.delta.ts>a.delta.ts)return b.delta;else{var c=a.delta.facet,d=a.delta.uuid;return d in b.uuids&&c in b.uuids[d]?{ts:b.delta.ts,uuid:d,facet:c,facetState:b.uuids[d][c]}:{ts:b.delta.ts,uuid:d,facet:c,facetState:null}}};
rhizo.state.overlord_=new rhizo.state.MasterOverlord;rhizo.state.getMasterOverlord=function(){return rhizo.state.overlord_};rhizo.state.history_=null;if(window.history&&typeof window.history.pushState=="function")rhizo.state.history_=new rhizo.state.HistoryHelper(rhizo.state.getMasterOverlord());rhizo.state.getHistoryHelper=function(){return rhizo.state.history_};namespace("rhizo");rhizo.nativeConsoleExists=function(){return typeof console!=="undefined"&&console!=null};rhizo.NoOpLogger=function(){};
rhizo.NoOpLogger.prototype.info=function(){};rhizo.NoOpLogger.prototype.error=function(){};rhizo.NoOpLogger.prototype.warn=function(){};rhizo.NativeLogger=function(){};rhizo.NativeLogger.prototype.info=function(a){console.info(a)};rhizo.NativeLogger.prototype.error=function(a){console.error(a)};rhizo.NativeLogger.prototype.warn=function(a){console.warn(a)};rhizo.Logger=function(a){this.console_=a.getComponent("rhizo.ui.component.Console");this.rightBar_=a.getComponent("rhizo.ui.component.RightBar")};
rhizo.Logger.prototype.log_=function(a,b){var c=b||"info",d="#888";switch(c){case "error":d="#ff0000";break;case "warn":d="#ffff00";break}var e=new Date;e=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+" ";c=$("<p class='rhizo-log-"+c+"'>"+e+a+"</p>");this.console_.getContents().prepend(c);b&&c.effect("highlight",{color:d},1E3);if(!this.console_.getContents().is(":visible")&&b)this.rightBar_&&!this.rightBar_.isCollapsed()?this.rightBar_.getToggle().effect("highlight",{color:d},1E3):this.console_.getHeader().effect("highlight",
{color:d},1E3)};rhizo.Logger.prototype.info=function(a){this.log_(a)};rhizo.Logger.prototype.error=function(a){this.log_(a,"error")};rhizo.Logger.prototype.warn=function(a){this.log_(a,"warn")};rhizo.meta.DecimalKind=function(a){rhizo.meta.NumberKind.call(this);this.precision_=a||2;this.input_=null};rhizo.inherits(rhizo.meta.DecimalKind,rhizo.meta.NumberKind);rhizo.meta.DecimalKind.prototype.survivesFilter=function(a,b){var c=parseFloat(a);return isNaN(c)?true:c.toFixed(this.precision_)==b.toFixed(this.precision_)};
rhizo.meta.DecimalKind.prototype.compare=function(a,b){return parseFloat(a)-parseFloat(b)};rhizo.meta.DecimalKind.prototype.cluster=function(a){a=parseFloat(a.toFixed(this.precision_),10);var b=rhizo.util.orderOfMagnitude(a);if(isNaN(b))return{key:0,label:(new Number(0)).toFixed(this.precision_)};a=Math.pow(10,b);b=Math.pow(10,b+1);return{key:a,label:rhizo.ui.toHumanLabel(a)+" - "+rhizo.ui.toHumanLabel(b)}};
rhizo.meta.DecimalRangeKind=function(a){rhizo.meta.RangeKind.call(this);this.precision_=typeof a=="number"?a:2;this.scale_=Math.pow(10,this.precision_)};rhizo.inherits(rhizo.meta.DecimalRangeKind,rhizo.meta.RangeKind);rhizo.meta.DecimalRangeKind.prototype.compare=rhizo.meta.DecimalKind.prototype.compare;rhizo.meta.DecimalRangeKind.prototype.cluster=rhizo.meta.DecimalKind.prototype.cluster;rhizo.meta.DecimalRangeKind.prototype.toModelScale=function(a){return parseFloat((a/this.scale_).toFixed(this.precision_))};
rhizo.meta.DecimalRangeKind.prototype.toFilterScale=function(a){return Math.round(a*this.scale_)};rhizo.meta.LogarithmRangeKind=function(a,b){rhizo.meta.DecimalRangeKind.call(this,a);this.oneplus_=!!b};rhizo.inherits(rhizo.meta.LogarithmRangeKind,rhizo.meta.DecimalRangeKind);rhizo.meta.LogarithmRangeKind.prototype.toModelScale=function(a){var b=this.oneplus_?-1:0;return parseFloat(Math.pow(10,a/this.scale_).toFixed(this.precision_))+b};
rhizo.meta.LogarithmRangeKind.prototype.toFilterScale=function(a){a=this.oneplus_?a+1:a;return Math.round(rhizo.util.log10_(a)*this.scale_)};rhizo.meta.StringArrayKind=function(){rhizo.meta.StringKind.call(this)};rhizo.inherits(rhizo.meta.StringArrayKind,rhizo.meta.StringKind);rhizo.meta.StringArrayKind.prototype.survivesFilter=function(a,b){if(a!="")for(var c=0;c<b.length;c++)if(b[c].toLowerCase().indexOf(a.toLowerCase())!=-1)return true;return false};
rhizo.meta.StringArrayKind.prototype.cluster=function(){return{key:"undefined",label:"Clustering unsupported for this datatype."}};rhizo.meta.Kind.DECIMAL=function(){return new rhizo.meta.DecimalKind};rhizo.meta.Kind.DECIMALRANGE=function(){return new rhizo.meta.DecimalRangeKind};rhizo.meta.Kind.LOGARITHMRANGE=function(){return new rhizo.meta.LogarithmRangeKind};rhizo.meta.Kind.STRINGARRAY=function(){return new rhizo.meta.StringArrayKind};namespace("rhizo.layout");
rhizo.layout.metaModelKeySelector=function(a,b,c){b=$("<select class='"+b+"' />");if(a&&a.metaModel())for(var d in a.metaModel())if(!c||c(d,a.metaModel()[d]))b.append("<option value='"+d+"'>"+a.metaModel()[d].label+"</option>");return b};rhizo.layout.firstMetamodelKey=function(a,b){for(var c in a.metaModel())if(!b||b(c,a.metaModel()[c]))return c;return null};
rhizo.layout.orMatcher=function(){var a=Array.prototype.slice.call(arguments);return function(b,c){for(var d=0;d<a.length;d++)if(a[d](b,c))return true;return false}};rhizo.layout.linkMatcher=function(a,b){return!!b.isLink};rhizo.layout.hierarchyMatcher=function(a,b){return b.kind instanceof rhizo.meta.CategoryKind&&!!b.isHierarchy};rhizo.layout.numericMatcher=function(a,b){return b.kind.isNumeric()};
rhizo.layout.LayoutBox=function(a,b){this.height=this.width=this.right=this.left=this.bottom=this.top=0;this.maxWidth_=$(a).width();this.maxHeight_=$(a).height();this.computeLayoutBox_(b||{})};
rhizo.layout.LayoutBox.prototype.computeLayoutBox_=function(a){this.top=this.getAbsoluteDimension_(a.top,this.maxHeight_);if(a.height){this.height=this.getAbsoluteDimension_(a.height,this.maxHeight_);this.bottom=this.maxHeight_-this.top-this.height}else{this.bottom=this.clamp_(this.getAbsoluteDimension_(a.bottom,this.maxHeight_),0,this.maxHeight_-this.top);this.height=this.maxHeight_-this.top-this.bottom}this.left=this.getAbsoluteDimension_(a.left,this.maxWidth_);if(a.width){this.width=this.getAbsoluteDimension_(a.width,
this.maxWidth_);this.right=this.maxWidth_-this.left-this.width}else{this.right=this.clamp_(this.getAbsoluteDimension_(a.right,this.maxWidth_),0,this.maxWidth_-this.left);this.width=this.maxWidth_-this.left-this.right}};rhizo.layout.LayoutBox.prototype.getAbsoluteDimension_=function(a,b){a=a||0;return this.clamp_(Math.round(a*(a<1?b:1)),0,b)};rhizo.layout.LayoutBox.prototype.clamp_=function(a,b,c){return Math.min(c,Math.max(b,a))};
rhizo.layout.newTreeifier=function(a,b){return rhizo.layout.linkMatcher(a,b)?new rhizo.layout.LinkTreeifier(a,b.linkKey):rhizo.layout.hierarchyMatcher(a,b)?new rhizo.layout.CategoryTreeifier(a):null};rhizo.layout.CategoryTreeifier=function(a){this.categoryKey_=a};
rhizo.layout.CategoryTreeifier.prototype.buildTree=function(a,b,c){b=new rhizo.layout.TreeNode;for(var d=0,e=a.length;d<e;d++){var f=a[d].unwrap()[this.categoryKey_];$.isArray(f)||(f=[f]);for(var g=b,h=0;h<f.length;h++){var i="__syntethic_id_"+f[h],j=g.childs[i];if(!j){j=new rhizo.layout.SyntheticTreeNode(i,f[h]);g.addChild(j)}g=j}f=new rhizo.layout.ModelTreeNode(a[d]);g.addChild(f);if(c)c[a[d].id]=f}return b};rhizo.layout.LinkTreeifier=function(a,b){this.linkStartKey_=a;this.linkEndKey_=b||"id"};
rhizo.layout.LinkTreeifier.prototype.buildTree=function(a,b,c){var d=b;if(this.linkEndKey_!="id")d=this.buildLinkMap_(b);b=c||{};c=0;for(var e=a.length;c<e;c++)b[a[c].id]=new rhizo.layout.ModelTreeNode(a[c]);var f=new rhizo.layout.TreeNode;c=0;for(e=a.length;c<e;c++)if(!b[a[c].unwrap().id].traversed_)for(var g={},h=a[c].unwrap();;){if(g[h.id])throw new rhizo.layout.TreeCycleException("Tree is invalid: cycle detected");g[h.id]=true;b[h.id].traversed_=true;var i=this.findFirstAvailableParent_(d,d[h[this.linkStartKey_]]);
if(i&&i.id!=h.id){var j=i.unwrap();b[j.id].addChild(b[h.id]);h=i.unwrap()}else{f.addChild(b[h.id]);break}}return f};rhizo.layout.LinkTreeifier.prototype.findFirstAvailableParent_=function(a,b){if(!b)return null;for(var c={};!b.isAvailableForLayout();){if(c[b.id])throw new rhizo.layout.TreeCycleException("Tree is invalid: hidden cycle detected");c[b.id]=true;b=a[b.unwrap()[this.linkStartKey_]];if(!b)return null}return b};
rhizo.layout.LinkTreeifier.prototype.buildLinkMap_=function(a){var b={};for(var c in a){var d=a[c].unwrap();if(this.linkEndKey_ in d){if(d[this.linkEndKey_]in b)throw new rhizo.layout.TreeCycleException("Tree is invalid: multiple models have the same value for the "+this.linkEndKey_+" attribute");b[d[this.linkEndKey_]]=a[c]}}return b};rhizo.layout.TreeNode=function(a,b){this.id=a;this.childs={};this.traversed_=false;this.numChilds=0;this.is_root=this.id==null;this.synthetic_=false;this.payload_=b};
rhizo.layout.TreeNode.prototype.setSynthetic=function(a){this.synthetic_=a};rhizo.layout.TreeNode.prototype.synthetic=function(){return this.synthetic_};rhizo.layout.TreeNode.prototype.payload=function(){return this.payload_};rhizo.layout.TreeNode.prototype.addChild=function(a){if(!this.childs[a.id]){this.childs[a.id]=a;this.numChilds++}};rhizo.layout.TreeNode.prototype.childsAsArray=function(){var a=[];for(var b in this.childs)a.push(this.childs[b]);return a};
rhizo.layout.TreeNode.prototype.deepChildsAsArray=function(a){for(var b in this.childs){a.push(this.childs[b]);this.childs[b].deepChildsAsArray(a)}};rhizo.layout.TreeNode.prototype.renderingDimensions=function(){return{width:0,height:0}};rhizo.layout.ModelTreeNode=function(a){rhizo.layout.TreeNode.call(this,a?a.id:null,a)};rhizo.inherits(rhizo.layout.ModelTreeNode,rhizo.layout.TreeNode);rhizo.layout.ModelTreeNode.prototype.renderingDimensions=function(){return this.payload().rendering().getDimensions()};
rhizo.layout.SyntheticTreeNode=function(a,b){rhizo.layout.TreeNode.call(this,a,b);this.setSynthetic(true);this.syntheticRendering_=null};rhizo.inherits(rhizo.layout.SyntheticTreeNode,rhizo.layout.TreeNode);rhizo.layout.SyntheticTreeNode.prototype.renderingDimensions=function(){return this.syntheticRendering_.getDimensions()};rhizo.layout.SyntheticTreeNode.prototype.setSyntheticRendering=function(a){this.syntheticRendering_=a};rhizo.layout.SyntheticTreeNode.prototype.syntheticRendering=function(){return this.syntheticRendering_};
rhizo.layout.TreeCycleException=function(a){this.message=a;this.name="TreeCycleException"};rhizo.layout.TreeCycleException.prototype.toString=function(){return this.name+": "+this.message};namespace("rhizo.model");rhizo.model.SuperModel=function(a){this.model=a;this.id=a.id;this.filters_={};this.rendering_=null;this.pinned_=this.selected_=false};rhizo.model.SuperModel.prototype.setRendering=function(a){this.rendering_=a};rhizo.model.SuperModel.prototype.rendering=function(){return this.rendering_};
rhizo.model.SuperModel.prototype.unwrap=function(){return this.model};rhizo.model.SuperModel.prototype.isAvailableForLayout=function(){return!this.isFiltered()&&!this.isPinned()};rhizo.model.SuperModel.prototype.setSelected=function(a){this.selected_=!!a;this.rendering_.setSelected(this.selected_)};rhizo.model.SuperModel.prototype.pin=function(){this.pinned_=true};rhizo.model.SuperModel.prototype.unpin=function(){this.pinned_=false};rhizo.model.SuperModel.prototype.isPinned=function(){return this.pinned_};
rhizo.model.SuperModel.prototype.toString=function(){return this.model.toString()};rhizo.model.SuperModel.prototype.isFiltered=function(a){if(a)return this.filters_[a]||false;else{a=0;for(var b in this.filters_)a++;return a!=0}};rhizo.model.SuperModel.prototype.filter=function(a){this.filters_[a]=true};rhizo.model.SuperModel.prototype.resetFilter=function(a){if(a in this.filters_){delete this.filters_[a];return true}else return false};rhizo.model.SuperModel.prototype.modelChanged=function(){this.rendering_.modelChanged()};
namespace("rhizo.autorender");rhizo.autorender.AR=function(a,b,c,d){this.metamodel_=a;this.metamodelFields_=0;for(var e in this.metamodel_)this.metamodelFields_++;this.fallbackToDefaults_=typeof c=="undefined"?true:c;this.locateFields_();a=0;if(this.sizeField_){this.sizeRange_=this.locateMinMax_(b,this.sizeField_);a++}if(this.colorField_){this.colorRange_=this.locateMinMax_(b,this.colorField_);a++}this.numfields_=typeof d=="undefined"?5:Math.max(d,a);this.cacheDimensions=true};
rhizo.autorender.AR.prototype.getSizeRange=function(){return this.sizeRange_};rhizo.autorender.AR.prototype.getColorRange=function(){return this.colorRange_};rhizo.autorender.AR.prototype.locateFields_=function(){for(var a in this.metamodel_){this.masterField_=this.masterField_||this.getArField_(a,"master","true");this.sizeField_=this.sizeField_||this.getArField_(a,"bind","size");this.colorField_=this.colorField_||this.getArField_(a,"bind","color")}this.locateDefaultFields_()};
rhizo.autorender.AR.prototype.getArField_=function(a,b,c){if(this.metamodel_[a].ar)if((b=this.metamodel_[a].ar[b])&&b.toString().indexOf(c)!=-1)return a;return null};
rhizo.autorender.AR.prototype.locateDefaultFields_=function(){for(var a in this.metamodel_){if(!this.masterField_)this.masterField_=a;if(!this.fallbackToDefaults_)break;var b=rhizo.meta.objectify(this.metamodel_[a].kind);if(!this.sizeField_&&b.isNumeric())this.sizeField_=a;else if(this.sizeField_)if(!this.colorField_&&b.isNumeric())this.colorField_=a}};
rhizo.autorender.AR.prototype.locateMinMax_=function(a,b){if(rhizo.meta.objectify(this.metamodel_[b].kind).isNumeric()&&typeof this.metamodel_[b].min!="undefined"&&typeof this.metamodel_[b].max!="undefined")return{min:this.metamodel_[b].min,max:this.metamodel_[b].max,label:this.metamodel_[b].label};else{var c=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY;$.each(a,function(e,f){c=Math.min(c,f[b]);d=Math.max(d,f[b])});return{min:c,max:d,label:this.metamodel_[b].label}}};
rhizo.autorender.AR.prototype.getClass_=function(a,b,c,d){a=parseInt((a-b.min)/(b.max-b.min)*5,10);return"ar-"+d+"-"+a.toString()+(c.small?"m":"")};rhizo.autorender.AR.prototype.getFontClass_=function(a,b,c){return this.getClass_(a,b,c,"fon")};rhizo.autorender.AR.prototype.getColorClass_=function(a,b,c){return this.getClass_(a,b,c,"col")};
rhizo.autorender.AR.prototype.renderSingleModelKey_=function(a,b){var c=[];c.push('<p><span class="rhizo-autorender-label">');c.push(this.metamodel_[a].label);c.push("</span>: ");c.push(b);c.push("</p>");return c.join("")};rhizo.autorender.AR.prototype.expandable=function(a){return this.metamodelFields_>(a.small?1:this.numfields_+1)};
rhizo.autorender.AR.prototype.render=function(a,b,c){var d="ar-col-0"+(c.small?"m":"");if(this.colorField_)d=this.getColorClass_(a[this.colorField_],this.colorRange_,c);var e="ar-fon-0"+(c.small?"m":"");if(this.sizeField_)e=this.getFontClass_(a[this.sizeField_],this.sizeRange_,c);if(c.small&&!b)return $("<div class='rhizo-autorender "+d+"'><span class='"+e+"'>"+a[this.masterField_]+"</span></div>");else{c=[];c.push("<div class='rhizo-autorender "+d+"'>");c.push("<span class='"+e+"'>"+a[this.masterField_]+
"</span>");d=0;if(this.sizeField_){c.push(this.renderSingleModelKey_(this.sizeField_,a[this.sizeField_]));d++}if(this.colorField_&&this.colorField_!=this.sizeField_){c.push(this.renderSingleModelKey_(this.colorField_,a[this.colorField_]));d++}for(var f in this.metamodel_){if(d>=this.numfields_&&!b)break;if(f!=this.sizeField_&&f!=this.colorField_&&f!=this.masterField_){d++;c.push(this.renderSingleModelKey_(f,a[f]))}}c.push("</div>");return $(c.join(""))}};namespace("rhizo.gviz");
rhizo.gviz.Rhizosphere=function(a){if(typeof google=="undefined"||typeof google.visualization=="undefined")throw"Google Visualization APIs not available. Please load them first.";this.container_=a;this.project_=null};
rhizo.gviz.Rhizosphere.prototype.draw=function(a,b){this.project_&&this.project_.destroy();var c=new rhizo.bootstrap.Bootstrap(this.container_,b,jQuery.proxy(this.ready_,this)),d=rhizo.nativeConsoleExists()?new rhizo.NativeLogger:new rhizo.NoOpLogger;this.project_=c.prepare();d=new rhizo.gviz.Initializer(a,d,b);d.parse()?c.deployExplicit(d.models,d.metamodel,d.renderer):this.ready_()};rhizo.gviz.Rhizosphere.prototype.ready_=function(){google.visualization.events.trigger(this,"ready",{})};
rhizo.gviz.Initializer=function(a,b,c){this.dt_=a;this.logger_=b;this.options_=c||{}};
rhizo.gviz.Initializer.prototype.parse=function(){if(this.dt_.getNumberOfRows()==0||this.dt_.getNumberOfColumns()==0)return false;var a=this.getColumnGroupings_();if(this.transformDataTableIfNeeded_(a))a=this.getColumnGroupings_();this.metamodel=this.buildMetaModel_(a);this.models=this.loadModels_(this.metamodel,a);this.renderer=this.options_.renderer?this.options_.renderer:this.createDefaultRenderer_(this.metamodel,this.models);return true};
rhizo.gviz.Initializer.prototype.getColumnId_=function(a){return this.dt_.getColumnId(a)||"col_"+a};rhizo.gviz.Initializer.prototype.getColumnGroupId_=function(a,b){return this.getColumnId_(a)+"__"+this.getColumnId_(b-1)};rhizo.gviz.Initializer.prototype.getColumnLabel_=function(a){var b=this.dt_.getColumnLabel(a);if(b=="")b="Column "+this.getColumnId_(a);return b};
rhizo.gviz.Initializer.prototype.isParentColumn_=function(a){if(a==0)return false;return!!this.dt_.getColumnProperty(a,"rhizosphereParent")||this.getColumnLabel_(a)=="Parent"+this.getColumnLabel_(a-1)};
rhizo.gviz.Initializer.prototype.getCategoryColumnData_=function(a){var b=this.dt_.getColumnProperty(a,"rhizosphereCategory");if(b)return{multiple:!!b.multiple,hierarchy:!!b.hierarchy};if(this.getColumnLabel_(a).indexOf("CAT")!=-1)return{multiple:this.getColumnLabel_(a).indexOf("MUL")!=-1,hierarchy:this.getColumnLabel_(a).indexOf("HIE")!=-1};return null};rhizo.gviz.Initializer.stripCategoryTokens_=function(a){return a.replace(/CAT|MUL|HIE/g,"").replace(/^\s+|\s+$/g,"")};
rhizo.gviz.Initializer.prototype.getColumnGroupings_=function(){for(var a={},b=this.dt_.getNumberOfColumns(),c=0,d=this.getColumnLabel_(c),e=1;e<b;e++)if(this.getColumnLabel_(e)!=d){if(e>c+1)a[c]=e;c=e;d=this.getColumnLabel_(c)}if(c!=b-1)a[c]=b;return a};
rhizo.gviz.Initializer.prototype.transformDataTableIfNeeded_=function(a){for(var b=0,c=this.dt_.getNumberOfColumns();b<c;)if(b in a){if(this.isValidModelTree_(b,a[b])){this.logger_.info("Column group starting at "+b+" is a valid model tree. Transforming the datatable.");this.packHierarchy_(b,a[b]);return true}b=a[b]}else{var d=this.getCategoryColumnData_(b);if(d&&d.hierarchy)if(this.isValidModelTree_(b)){this.logger_.info("Hierarchy column at position "+b+" is a valid model tree. Transforming the datatable.");
this.packHierarchy_(b);return true}b+=1}return false};rhizo.gviz.Initializer.prototype.isValidModelTree_=function(a,b){for(var c={},d={},e=0,f=0,g=this.dt_.getNumberOfRows();f<g;f++)for(var h=d,i=rhizo.gviz.Initializer.getRowCategories_(this.dt_,f,a,b),j=0;j<i.length;j++){var k=i[j];if(!(k in h)){if(k in c)return false;c[k]=true;h[k]={};e++}h=h[k]}return e==this.dt_.getNumberOfRows()};
rhizo.gviz.Initializer.prototype.packHierarchy_=function(a,b){for(var c=new google.visualization.DataView(this.dt_),d=[],e=0;e<a;e++)d.push(e);d.push({type:"string",id:"c("+this.getColumnId_(a)+(b?":"+this.getColumnId_(b-1):"")+")",label:this.dt_.getColumnLabel(a),calc:function(f,g){return rhizo.gviz.Initializer.packFunction_(f,g,a,b,0)}});d.push({type:"string",id:"p("+this.getColumnId_(a)+(b?":"+this.getColumnId_(b-1):"")+")",label:"Parent"+this.dt_.getColumnLabel(a),calc:function(f,g){return rhizo.gviz.Initializer.packFunction_(f,
g,a,b,1)}});for(e=b||a+1;e<this.dt_.getNumberOfColumns();e++)d.push(e);c.setColumns(d);this.dt_=c};rhizo.gviz.Initializer.packFunction_=function(a,b,c,d,e){a=rhizo.gviz.Initializer.getRowCategories_(a,b,c,d);return a.length-1-e<0?null:a[a.length-1-e]};
rhizo.gviz.Initializer.prototype.buildMetaModel_=function(a){for(var b={},c=0,d=this.dt_.getNumberOfColumns();c<d;){var e=null,f=null,g=null,h=null;if(c in a){e=this.getColumnGroupId_(c,a[c]);f=this.buildMetaModelEntry_(e,c,a[c]);c=a[c]}else{e=this.getColumnId_(c);f=this.buildMetaModelEntry_(e,c);c+=1;if(c!=d&&this.isParentColumn_(c)){g=this.getColumnId_(c);h=this.buildMetaModelEntry_(g,c);h.isLink=true;h.linkKey=e;c+=1}}b[e]=f;if(g)b[g]=h}return b};
rhizo.gviz.Initializer.prototype.buildMetaModelEntry_=function(a,b,c){var d={};d.label=this.getColumnLabel_(b);if(c)this.buildMetaModelCategoryEntry_(d,b,c);else{c=this.dt_.getColumnType(b);if(c=="number"){c=this.dt_.getColumnRange(b).min;b=this.dt_.getColumnRange(b).max;if(c==b)d.kind=rhizo.meta.Kind.NUMBER;else{d.kind=rhizo.meta.Kind.RANGE;d.min=c;d.max=b}}else if(c=="boolean")d.kind=rhizo.meta.Kind.BOOLEAN;else{c!="string"&&this.logger_.warn("Column "+d.label+" will be treated as String. Unsupported type: "+
c);if(c=this.getCategoryColumnData_(b))this.buildMetaModelCategoryEntry_(d,b,null,c);else d.kind=rhizo.meta.Kind.STRING}}this.buildAutoRenderInfo_(a,d);return d};rhizo.gviz.Initializer.prototype.buildMetaModelCategoryEntry_=function(a,b,c,d){a.kind=rhizo.meta.Kind.CATEGORY;a.categories=rhizo.gviz.Initializer.getAllCategories_(this.dt_,b,c);a.isHierarchy=c||d&&d.hierarchy;a.multiple=d&&d.multiple;if(d)a.label=rhizo.gviz.Initializer.stripCategoryTokens_(a.label)};
rhizo.gviz.Initializer.getAllCategories_=function(a,b,c){var d=[];if(c)for(var e=0,f=a.getNumberOfRows();e<f;e++)for(var g=b;g<c;g++)d.push(a.getValue(e,g));else{e=0;for(f=a.getNumberOfRows();e<f;e++)Array.prototype.push.apply(d,rhizo.gviz.Initializer.splitCSVCategory_(a.getValue(e,b)))}return rhizo.gviz.Initializer.cleanCategories_(d).sort()};
rhizo.gviz.Initializer.getRowCategories_=function(a,b,c,d){var e=[];if(d)for(c=c;c<d;c++)e.push(a.getValue(b,c));else e=rhizo.gviz.Initializer.splitCSVCategory_(a.getValue(b,c));return rhizo.gviz.Initializer.cleanCategories_(e)};rhizo.gviz.Initializer.splitCSVCategory_=function(a){if(a==null||String(a)=="")return[];return String(a).split(",")};
rhizo.gviz.Initializer.cleanCategories_=function(a){var b=$.grep(a,function(e){return e!=null&&String(e)!=""});a={};for(var c=0;c<b.length;c++)a[String(b[c]).replace(/^\s+|\s+$/g,"")]=true;b=[];for(var d in a)b.push(d);return b};
rhizo.gviz.Initializer.prototype.buildAutoRenderInfo_=function(a,b){var c={},d=false;if(this.options_.arMaster&&this.matchAutoRenderOption_(this.options_.arMaster,b.label,a))d=c.master=true;if(this.options_.arSize&&this.matchAutoRenderOption_(this.options_.arSize,b.label,a)){c.bind=(c.bind?c.bind:"")+"size ";d=true}if(this.options_.arColor&&this.matchAutoRenderOption_(this.options_.arColor,b.label,a)){c.bind=(c.bind?c.bind:"")+"color ";d=true}if(d)b.ar=c};
rhizo.gviz.Initializer.prototype.matchAutoRenderOption_=function(a,b,c){a=a.toLowerCase();if(/^[a-z]$/.test(a)){c=String(c).toLowerCase();return c==a||c.indexOf(a+"__")==0||c.indexOf("c("+a+":")==0}else return b.toLowerCase()==a};
rhizo.gviz.Initializer.prototype.loadModels_=function(a,b){for(var c=[],d=0,e=this.dt_.getNumberOfRows();d<e;d++){for(var f={id:"gviz-"+d},g=0,h=this.dt_.getNumberOfColumns();g<h;)if(g in b){f[this.getColumnGroupId_(g,b[g])]=rhizo.gviz.Initializer.getRowCategories_(this.dt_,d,g,b[g]);g=b[g]}else{if(a[this.getColumnId_(g)].kind==rhizo.meta.Kind.CATEGORY)f[this.getColumnId_(g)]=rhizo.gviz.Initializer.getRowCategories_(this.dt_,d,g);else f[this.getColumnId_(g)]=this.dt_.getValue(d,g);g++}c.push(f)}return c};
rhizo.gviz.Initializer.prototype.createDefaultRenderer_=function(a,b){return new rhizo.autorender.AR(a,b,this.options_.arDefaults,this.options_.arNumFields)};rhizo.gviz.DebugRenderer=function(a){this.dt_=a};rhizo.gviz.DebugRenderer.prototype.getColumnId_=function(a){return this.dt_.getColumnId(a)||"col_"+a};rhizo.gviz.DebugRenderer.prototype.render=function(a){for(var b=$("<div />"),c=0,d=this.dt_.getNumberOfColumns();c<d;c++)b.append("<p>"+a[this.getColumnId_(c)]+"</p>");return b};namespace("rhizo.layout");
rhizo.layout.StatefulLayout=function(a){this.project_=a;this.state_=this.defaultState_()};rhizo.layout.StatefulLayout.prototype.getState=function(){return this.state_};rhizo.layout.StatefulLayout.prototype.setState=function(a){if(!a){this.state_=this.defaultState_();return true}if(this.validateState_(a)){this.state_=this.cloneState_(a);return true}else return false};rhizo.layout.StatefulLayout.prototype.defaultState_=function(){return null};rhizo.layout.StatefulLayout.prototype.validateState_=function(){return true};
rhizo.layout.StatefulLayout.prototype.validateStateAttributePresence_=function(a,b){if(!(b in a)){this.project_.logger().error("State must specify a "+b+" attribute");return false}return true};
rhizo.layout.StatefulLayout.prototype.validateMetamodelPresence_=function(a,b){if(!(a in this.project_.metaModel())){this.project_.logger().error(a+" is not part of the metamodel.");return false}if(b&&!b(a,this.project_.metaModel()[a])){this.project_.logger().error(a+" does not match the required constraints");return false}return true};rhizo.layout.StatefulLayout.prototype.cloneState_=function(a){return $.extend({},a)};
rhizo.layout.GUILayout=function(a,b){rhizo.layout.StatefulLayout.call(this,a);this.ui_=b;this.ui_controls_=null};rhizo.inherits(rhizo.layout.GUILayout,rhizo.layout.StatefulLayout);rhizo.layout.GUILayout.prototype.layoutUIControls=function(){if(!this.ui_controls_){this.ui_controls_=this.ui_.renderControls();this.ui_.setState(this.getState())}return this.ui_controls_};
rhizo.layout.GUILayout.prototype.setState=function(a){(a=rhizo.layout.StatefulLayout.prototype.setState.call(this,a))&&this.ui_controls_&&this.ui_.setState(this.getState());return a};rhizo.layout.GUILayout.prototype.setStateFromUI=function(a){return rhizo.layout.StatefulLayout.prototype.setState.call(this,a)};rhizo.layout.NoLayout=function(){};rhizo.layout.NoLayout.prototype.layout=function(){return false};rhizo.layout.NoLayout.prototype.toString=function(){return"-"};
rhizo.layout.ScrambleLayout=function(){};rhizo.layout.ScrambleLayout.prototype.layout=function(a,b,c,d,e,f){if(f.filter)return false;d=0;for(e=c.length;d<e;d++)a.move(c[d].id,Math.round(b.height*0.05+Math.random()*0.85*b.height),Math.round(b.width*0.05+Math.random()*0.85*b.width));return false};rhizo.layout.ScrambleLayout.prototype.toString=function(){return"Random"};
rhizo.layout.FlowLayout=function(a,b,c){this.project_=a;this.top=b||5;this.left=c||5;rhizo.layout.GUILayout.call(this,a,new rhizo.layout.FlowLayoutUI(this,a))};rhizo.inherits(rhizo.layout.FlowLayout,rhizo.layout.GUILayout);rhizo.layout.FlowLayout.prototype.defaultState_=function(){return{order:rhizo.layout.firstMetamodelKey(this.project_),reverse:false}};rhizo.layout.FlowLayout.prototype.validateState_=function(a){return this.validateStateAttributePresence_(a,"order")&&this.validateMetamodelPresence_(a.order)};
rhizo.layout.FlowLayout.prototype.layout=function(a,b,c,d,e){var f=this.getState().order,g=!!this.getState().reverse;b=b.width;d=0;this.project_.logger().info("Sorting by "+f);c.sort(rhizo.meta.sortBy(f,e[f].kind,g));e=0;for(f=c.length;e<f;e++){g=c[e].rendering().getDimensions();d=Math.max(d,g.height);if(this.left+g.width>b){this.left=5;this.top+=d+5;d=g.height}a.move(c[e].id,this.top,this.left);this.left+=g.width+5}this.top+=d;return false};
rhizo.layout.FlowLayout.prototype.cleanup=function(){this.top=this.left=5;return false};rhizo.layout.FlowLayout.prototype.toString=function(){return"List"};rhizo.layout.FlowLayoutUI=function(a,b){this.layout_=a;this.project_=b;this.reverseCheckbox_=this.orderSelector_=null};
rhizo.layout.FlowLayoutUI.prototype.renderControls=function(){this.orderSelector_=rhizo.layout.metaModelKeySelector(this.project_,"rhizo-flowlayout-order").change(jQuery.proxy(this.updateState_,this));this.reverseCheckbox_=$('<input type="checkbox" class="rhizo-flowlayout-desc" />').click(jQuery.proxy(this.updateState_,this));return $("<div />").append("Ordered by: ").append(this.orderSelector_).append(" desc?").append(this.reverseCheckbox_)};
rhizo.layout.FlowLayoutUI.prototype.setState=function(a){this.orderSelector_.val(a.order);a.reverse?this.reverseCheckbox_.attr("checked","checked"):this.reverseCheckbox_.removeAttr("checked")};rhizo.layout.FlowLayoutUI.prototype.updateState_=function(){this.layout_.setStateFromUI({order:this.orderSelector_.val(),reverse:this.reverseCheckbox_.is(":checked")})};
rhizo.layout.BucketLayout=function(a){this.project_=a;this.internalFlowLayout_=new rhizo.layout.FlowLayout(a);rhizo.layout.GUILayout.call(this,a,new rhizo.layout.BucketLayoutUI(this,a))};rhizo.inherits(rhizo.layout.BucketLayout,rhizo.layout.GUILayout);rhizo.layout.BucketLayout.prototype.defaultState_=function(){return{bucketBy:rhizo.layout.firstMetamodelKey(this.project_),reverse:false}};
rhizo.layout.BucketLayout.prototype.validateState_=function(a){return this.validateStateAttributePresence_(a,"bucketBy")&&this.validateMetamodelPresence_(a.bucketBy)};
rhizo.layout.BucketLayout.prototype.layout=function(a,b,c,d,e,f){var g=!!this.getState().reverse,h=this.getState().bucketBy;this.project_.logger().info("Bucketing by "+h);this.internalFlowLayout_.setState({order:h,reverse:g});var i,j;if(e[h].cluster){i=e[h].cluster;j=e[h]}else{i=e[h].kind.cluster;j=e[h].kind}for(var k={},n={},m=0,p=c.length;m<p;m++){var l=c[m].unwrap()[h],o=l;if(i){o=i.call(j,l);l=o.key;o=o.label}if(!k[l]){k[l]=[];n[l]=o}k[l].push(c[m])}c=[];for(l in k)c.push(l);c.sort(rhizo.meta.sortByKind(e[h].kind,
g));g=false;h=true;for(m=0;m<c.length;m++){l=c[m];this.renderBucketHeader_(a,n[l],k[l],h);g=this.internalFlowLayout_.layout(a,b,k[l],d,e,f)||g;this.internalFlowLayout_.top+=10;this.internalFlowLayout_.left=5;h=false}return g};
rhizo.layout.BucketLayout.prototype.renderBucketHeader_=function(a,b,c,d){for(var e=Array(c.length),f=c.length-1;f>=0;f--)e[f]=c[f].id;c=$("<div />",{"class":d?"rhizo-bucket-header rhizo-bucket-first":"rhizo-bucket-header"});c.text(b).css("position","absolute").css("left",5).css("top",this.internalFlowLayout_.top).click(jQuery.proxy(function(){this.project_.toggleSelect(e)},this));a.artifact(c);this.internalFlowLayout_.top+=c.height()+5};
rhizo.layout.BucketLayout.prototype.cleanup=function(a,b){this.internalFlowLayout_.cleanup(a,b);return false};rhizo.layout.BucketLayout.prototype.toString=function(){return"Buckets"};rhizo.layout.BucketLayoutUI=function(a,b){this.layout_=a;this.project_=b;this.reverseCheckbox_=this.bucketSelector_=null};
rhizo.layout.BucketLayoutUI.prototype.renderControls=function(){this.bucketSelector_=rhizo.layout.metaModelKeySelector(this.project_,"rhizo-bucketlayout-bucket").change(jQuery.proxy(this.updateState_,this));this.reverseCheckbox_=$('<input type="checkbox" class="rhizo-bucketlayout-desc" />').click(jQuery.proxy(this.updateState_,this));return $("<div />").append("Group by: ").append(this.bucketSelector_).append(" desc?").append(this.reverseCheckbox_)};
rhizo.layout.BucketLayoutUI.prototype.setState=function(a){this.bucketSelector_.val(a.bucketBy);a.reverse?this.reverseCheckbox_.attr("checked","checked"):this.reverseCheckbox_.removeAttr("checked")};rhizo.layout.BucketLayoutUI.prototype.updateState_=function(){this.layout_.setStateFromUI({bucketBy:this.bucketSelector_.val(),reverse:this.reverseCheckbox_.is(":checked")})};rhizo.layout.layouts={no:rhizo.layout.NoLayout,flow:rhizo.layout.FlowLayout,scramble:rhizo.layout.ScrambleLayout,bucket:rhizo.layout.BucketLayout};
namespace("rhizo");rhizo.Project=function(a,b){this.models_=[];this.modelsMap_={};this.selectionMap_={};this.options_=b||{};this.gui_=a;this.filterAutocommit_=true;this.logger_=rhizo.nativeConsoleExists()?new rhizo.NativeLogger:new rhizo.NoOpLogger;this.state_=null};rhizo.Project.prototype.chromeReady=function(){if(this.gui_.getComponent("rhizo.ui.component.Console"))this.logger_=new rhizo.Logger(this.gui_)};
rhizo.Project.prototype.metaReady=function(){if(!this.checkMetaModel_())return false;this.initializeLayoutEngines_();return true};rhizo.Project.prototype.initializeLayoutEngines_=function(){this.curLayoutName_="flow";this.layoutEngines_={};this.renderingPipeline_=new rhizo.ui.RenderingPipeline(this,this.gui_.universe);for(var a in rhizo.layout.layouts){var b=new rhizo.layout.layouts[a](this),c=true;if(b.verifyMetaModel&&!b.verifyMetaModel(this.metaModel_))c=false;if(c)this.layoutEngines_[a]=b}};
rhizo.Project.prototype.deploy=function(a){a&&this.addModels_(a)&&this.finalizeUI_();this.logger_.info("*** Ready!")};rhizo.Project.prototype.addModels_=function(a){for(var b=0;b<a.length;b++)this.models_[b]=new rhizo.model.SuperModel(a[b]);if(!this.checkModels_())return false;this.buildModelsMap_();return true};
rhizo.Project.prototype.finalizeUI_=function(){if((new rhizo.ui.RenderingBootstrap(this.renderer_,this.gui_,this,this.options_)).buildRenderings(this.models_)){this.gui_.disableFx(true);var a=[];this.options_.enableHTML5History&&a.push(rhizo.state.Bindings.HISTORY);a=rhizo.state.getMasterOverlord().attachProject(this,a);this.state_=rhizo.state.getMasterOverlord().projectBinder(this);a||this.layoutInternal_(this.curLayoutName_,{forcealign:true});this.alignFx()}};
rhizo.Project.prototype.destroy=function(){rhizo.state.getMasterOverlord().detachProject(this);for(var a=this.models_.length-1;a>=0;a--){var b=this.models_[a].rendering();b&&b.beforeDestroy()}this.gui_.destroy()};rhizo.Project.prototype.uuid=function(){return this.gui_.container.attr("id")};rhizo.Project.prototype.model=function(a){return this.modelsMap_[a]};rhizo.Project.prototype.metaModel=function(){return this.metaModel_};
rhizo.Project.prototype.setMetaModel=function(a){this.metaModel_=$.extend({},a);for(var b in this.metaModel_)this.metaModel_[b].kind||delete this.metaModel_[b];for(b in this.metaModel_){a=rhizo.meta.objectify(this.metaModel_[b].kind);this.metaModel_[b].kind=a}};rhizo.Project.prototype.renderer=function(){return this.renderer_};rhizo.Project.prototype.setRenderer=function(a){this.renderer_=a};rhizo.Project.prototype.gui=function(){return this.gui_};rhizo.Project.prototype.logger=function(){return this.logger_};
rhizo.Project.prototype.layoutEngines=function(){return this.layoutEngines_};rhizo.Project.prototype.currentLayoutEngineName=function(){return this.curLayoutName_};rhizo.Project.prototype.resetAllFilter=function(a){for(var b=false,c=this.models_.length-1;c>=0;c--)b=this.models_[c].resetFilter(a)||b;return b};
rhizo.Project.prototype.enableFilterAutocommit=function(a){if(this.filterAutocommit_=a)for(a=this.models_.length-1;a>=0;a--)if(this.models_[a].rendering().visibility==rhizo.ui.Visibility.GREY){this.commitFilter();break}};rhizo.Project.prototype.isFilterAutocommit=function(){return this.filterAutocommit_};rhizo.Project.prototype.select=function(a){a=this.extendSelection_(a);for(var b=a.length-1;b>=0;b--){var c=this.model(a[b]);this.selectionMap_[a[b]]=c;c.setSelected(true)}};
rhizo.Project.prototype.unselect=function(a){a=this.extendSelection_(a);for(var b=a.length-1;b>=0;b--)this.unselectInternal_(a[b])};rhizo.Project.prototype.toggleSelect=function(a){$.isArray(a)||(a=[a]);for(var b=true,c=a.length-1;c>=0;c--)if(!this.isSelected(a[c])){b=false;break}for(c=a.length-1;c>=0;c--)b?this.unselect(a[c]):this.select(a[c])};rhizo.Project.prototype.unselectAll=function(){for(var a in this.selectionMap_)this.unselectInternal_(a)};
rhizo.Project.prototype.unselectInternal_=function(a){var b=this.model(a);this.selectionMap_[a]=null;delete this.selectionMap_[a];b.setSelected(false)};rhizo.Project.prototype.isSelected=function(a){return this.selectionMap_[a]};rhizo.Project.prototype.allSelected=function(){return this.selectionMap_};rhizo.Project.prototype.allUnselected=function(){var a=this.selectionMap_;return $.grep(this.models_,function(b){return!a[b.id]})};
rhizo.Project.prototype.filterUnselected=function(){var a=0;for(var b in this.selectionMap_)a++;if(a==0){this.logger_.error("No items selected");return 0}a=[];for(b in this.modelsMap_)b in this.selectionMap_||a.push(b);this.state_.pushFilterSelectionChange(a);this.updateSelectionFilter_(a);this.layoutInternal_(this.curLayoutName_,{filter:true,forcealign:true});return a.length};
rhizo.Project.prototype.resetUnselected=function(){for(var a=0,b=this.models_.length-1;b>=0;b--)this.models_[b].isFiltered("__selection__")&&a++;if(a!=0){this.state_.pushFilterSelectionChange(null);this.updateSelectionFilter_(null);this.layoutInternal_(this.curLayoutName_,{filter:true,forcealign:true})}};
rhizo.Project.prototype.updateSelectionFilter_=function(a){a=a||[];if(a.length>0){for(var b={},c=a.length-1;c>=0;c--)b[a[c]]=true;for(c=this.models_.length-1;c>=0;c--)this.models_[c].id in b?this.models_[c].filter("__selection__"):this.models_[c].resetFilter("__selection__");this.unselectAll()}else this.resetAllFilter("__selection__");this.alignFx()};
rhizo.Project.prototype.extendSelection_=function(a){var b=this.layoutEngines_[this.curLayoutName_];if(b.dependentModels){b=b.dependentModels(a);b.push(a);return b}return[a]};
rhizo.Project.prototype.checkModels_=function(){this.logger_.info("Checking models...");for(var a={},b=false,c=[],d=this.models_.length-1;d>=0;d--){var e=this.models_[d].id;if(e)if(e in a)c.push(e);else a[e]=true;else b=true}b&&this.logger_.error("Verify your models: missing ids.");c.length>0&&this.logger_.error("Verify your models: duplicate ids ("+c.join(",")+")");return!b&&c.length==0};
rhizo.Project.prototype.checkMetaModel_=function(){var a=[];for(var b in this.metaModel_){if(!this.metaModel_[b].kind){this.logger_.error("Verify your metamodel: missing kind for "+b);return false}a.push(this.metaModel_[b].kind)}for(b=0;b<a.length;b++)for(var c=b+1;c<a.length;c++)if(a[b]===a[c]){this.logger_.error("Verify your metaModel: shared kind instances.");return false}return true};
rhizo.Project.prototype.buildModelsMap_=function(){this.logger_.info("Building models map...");for(var a=this.models_.length-1;a>=0;a--){var b=this.models_[a];this.modelsMap_[b.id]=b}};
rhizo.Project.prototype.setState=function(a){var b=this.curLayoutName_,c=false,d=null;rhizo.state.Facets.SELECTION_FILTER in a||(a[rhizo.state.Facets.SELECTION_FILTER]=[]);for(var e in this.metaModel_){var f=rhizo.state.Facets.FILTER_PREFIX+e;f in a||(a[f]=null)}for(f in a)if(f==rhizo.state.Facets.SELECTION_FILTER){c=true;e=a[f]||[];this.updateSelectionFilter_(e);this.alignSelectionUI_(e.length)}else if(f==rhizo.state.Facets.LAYOUT){b=(d=a[f])?d.layoutName:"flow";this.alignLayout_(b,d);d=d.positions}else if(f.indexOf(rhizo.state.Facets.FILTER_PREFIX)==
0){c=true;e=f.substring(rhizo.state.Facets.FILTER_PREFIX.length);var g=a[f];this.alignFilterUI_(e,g);this.filterInternal_(e,g)}this.layoutInternal_(b,{filter:c,forcealign:true});d&&this.moveModels_(d)};
rhizo.Project.prototype.stateChanged=function(a,b){if(a==rhizo.state.Facets.SELECTION_FILTER){var c=b||[];this.updateSelectionFilter_(c);this.alignSelectionUI_(c.length);this.layoutInternal_(this.curLayoutName_,{filter:true,forcealign:true})}else if(a==rhizo.state.Facets.LAYOUT){c=b?b.layoutName:"flow";this.alignLayout_(c,b);this.layoutInternal_(c);b&&b.positions&&this.moveModels_(b.positions)}else if(a.indexOf(rhizo.state.Facets.FILTER_PREFIX)==0){c=a.substring(rhizo.state.Facets.FILTER_PREFIX.length);
this.alignFilterUI_(c,b);if(this.filterInternal_(c,b))this.mustLayoutAfterFilter_()?this.commitFilter():this.alignVisibility_(rhizo.ui.Visibility.GREY)}};rhizo.Project.prototype.modelsMoved=function(a){var b=null;if(this.layoutEngines_[this.curLayoutName_].getState)b=this.layoutEngines_[this.curLayoutName_].getState();this.state_.pushLayoutChange(this.curLayoutName_,b,a)};
rhizo.Project.prototype.moveModels_=function(a){for(var b=a.length-1;b>=0;b--)a[b].id in this.modelsMap_&&this.modelsMap_[a[b].id].rendering().move(a[b].top,a[b].left)};
rhizo.Project.prototype.layout=function(a,b,c){if(a)if(!(a in this.layoutEngines_)){this.logger_.error("Invalid layout engine:"+a);return false}var d=a||this.curLayoutName_,e=this.layoutEngines_[d],f=null;if(b){if(!this.alignLayout_(d,b)){this.logger_.error("Received invalid layout state");return false}f=b}else if(e.getState)f=e.getState();this.state_.pushLayoutChange(d,f);this.layoutInternal_(a||this.curLayoutName_,c);return true};
rhizo.Project.prototype.layoutInternal_=function(a,b){var c=this.layoutEngines_[this.curLayoutName_],d=$.extend({},b,this.options_);this.curLayoutName_=a;var e=this.layoutEngines_[this.curLayoutName_],f=false;if(c&&c.cleanup)f=c.cleanup(c==e,d)||f;this.renderingPipeline_.cleanup();c!=e&&this.renderingPipeline_.backupManager().restoreAll();this.logger_.info("laying out...");this.gui_.universe.move(0,0,{bottom:0,right:0});c=jQuery.grep(this.models_,function(h){return h.isAvailableForLayout()});var g=
new rhizo.layout.LayoutBox(this.gui_.viewport,this.options_.layoutConstraints);f=e.layout(this.renderingPipeline_,g,c,this.modelsMap_,this.metaModel_,d)||f;e=this.renderingPipeline_.apply();this.gui_.universe.css({width:Math.max(e.width+e.left,this.gui_.viewport.width()),height:Math.max(e.height+e.top,this.gui_.viewport.height())}).move(0,0);if(f||d.forcealign)this.alignVisibility_()};
rhizo.Project.prototype.filter=function(a,b){if(this.filterInternal_(a,b)){this.state_.pushFilterChange(a,b);this.mustLayoutAfterFilter_()?this.commitFilter():this.alignVisibility_(rhizo.ui.Visibility.GREY)}};
rhizo.Project.prototype.filterInternal_=function(a,b){if(!(a in this.metaModel_))return false;if(b)for(var c=this.models_.length-1;c>=0;c--){var d=this.models_[c];this.metaModel_[a].kind.survivesFilter(b,d.unwrap()[a])?d.resetFilter(a):d.filter(a)}else if(!this.resetAllFilter(a))return false;this.alignFx();return true};
rhizo.Project.prototype.mustLayoutAfterFilter_=function(){if(this.filterAutocommit_)return true;else{for(var a=this.models_.length-1;a>=0;a--)if(!this.models_[a].isFiltered()&&this.models_[a].rendering().visibility==rhizo.ui.Visibility.HIDDEN)return true;return false}};rhizo.Project.prototype.commitFilter=function(){this.layoutInternal_(this.curLayoutName_,{filter:true,forcealign:true})};
rhizo.Project.prototype.alignLayout_=function(a,b){var c=true;if(this.layoutEngines_[a].setState)c=this.layoutEngines_[a].setState(b);if(c){var d=this.gui_.getComponent("rhizo.ui.component.Layout");d&&d.setEngine(a)}return c};rhizo.Project.prototype.alignSelectionUI_=function(a){var b=this.gui_.getComponent("rhizo.ui.component.SelectionManager");b&&b.setNumFilteredModels(a)};
rhizo.Project.prototype.alignFilterUI_=function(a,b){if(a in this.metaModel_){var c=true,d=this.gui_.getComponent("rhizo.ui.component.FilterStackContainer");if(d){b&&d.showFilter(a);c=d.isFilterActive(a)}c&&this.metaModel_[a].kind.setFilterValue(b)}};
rhizo.Project.prototype.alignFx=function(){for(var a=0,b=0,c=this.models_.length-1;c>=0;c--){this.models_[c].isFiltered()||a++;this.models_[c].rendering().visibility>=rhizo.ui.Visibility.GREY&&b++}this.gui_.disableFx(!this.options_.enableAnims||a>200||b>200)};
rhizo.Project.prototype.alignVisibility_=function(a){var b=rhizo.ui.Visibility;a=a||b.HIDDEN;for(var c=false,d=[],e=[],f=this.models_.length-1;f>=0;f--){var g=this.models_[f],h=g.rendering();if(g.isFiltered()){if(h.visibility>a){d.push(g);h.visibility=a}}else if(h.visibility<b.VISIBLE){c=c||h.visibility==b.HIDDEN;e.push(g);h.visibility=b.VISIBLE}}rhizo.ui.fadeAllRenderingsTo(d,a);rhizo.ui.fadeAllRenderingsTo(e,b.VISIBLE);return c};
rhizo.layout.TreeLayoutUI=function(a,b){this.layout_=a;this.project_=b;this.metaModelKeySelector_=this.directionSelector_=null;this.matcher_=rhizo.layout.orMatcher(rhizo.layout.linkMatcher,rhizo.layout.hierarchyMatcher)};
rhizo.layout.TreeLayoutUI.prototype.renderControls=function(){var a=this.getParentKeys_(),b=$("<div />");if(a.length==0){b.append("No hierarchical relationships exist");return b}b.append(" arrange ");this.directionSelector_=$("<select class='rhizo-treelayout-direction' />");this.directionSelector_.append("<option value='hor'>Horizontally</option>");this.directionSelector_.append("<option value='ver'>Vertically</option>");this.directionSelector_.change(jQuery.proxy(this.updateState_,this));b.append(this.directionSelector_);
if(a.length>1){this.metaModelKeySelector_=rhizo.layout.metaModelKeySelector(this.project_,"rhizo-treelayout-parentKey",this.matcher_);this.metaModelKeySelector_.change(jQuery.proxy(this.updateState_,this));b.append(" by ").append(this.metaModelKeySelector_)}else if(a.length==1)this.metaModelKeySelector_=$("<input type='hidden' />").val(a[0]);return b};
rhizo.layout.TreeLayoutUI.prototype.getParentKeys_=function(){var a=[];for(var b in this.project_.metaModel())this.matcher_(b,this.project_.metaModel()[b])&&a.push(b);return a};rhizo.layout.TreeLayoutUI.prototype.setState=function(a){this.directionSelector_.val(a.direction);this.metaModelKeySelector_&&this.metaModelKeySelector_.val(a.parentKey)};
rhizo.layout.TreeLayoutUI.prototype.updateState_=function(){var a={direction:this.directionSelector_.val()};if(this.metaModelKeySelector_)a.parentKey=this.metaModelKeySelector_.val();this.layout_.setStateFromUI(a)};rhizo.layout.TreeLayout=function(a){this.project_=a;this.matcher_=rhizo.layout.orMatcher(rhizo.layout.linkMatcher,rhizo.layout.hierarchyMatcher);this.globalNodesMap_=null;rhizo.layout.GUILayout.call(this,a,new rhizo.layout.TreeLayoutUI(this,a))};rhizo.inherits(rhizo.layout.TreeLayout,rhizo.layout.GUILayout);
rhizo.layout.TreeLayout.prototype.verifyMetaModel=function(a){for(var b in a)if(this.matcher_(b,a[b]))return true;return false};rhizo.layout.TreeLayout.prototype.defaultState_=function(){return{direction:"ver",parentKey:rhizo.layout.firstMetamodelKey(this.project_,this.matcher_)}};rhizo.layout.TreeLayout.prototype.validateState_=function(a){return this.validateStateAttributePresence_(a,"parentKey")&&this.validateMetamodelPresence_(a.parentKey,this.matcher_)};
rhizo.layout.TreeLayout.prototype.layout=function(a,b,c,d,e){var f=this.getState().parentKey;this.project_.logger().info("Creating tree by "+f);var g=this.getState().direction=="ver";this.treePainter_=new rhizo.layout.TreePainter(this.project_,g);try{this.globalNodesMap_={};var h=(new rhizo.layout.newTreeifier(f,e[f])).buildTree(c,d,this.globalNodesMap_).childs;c={left:0,top:0};d=0;for(var i in h){this.treePainter_.fillSyntheticRenderings_(h[i],a);var j=this.treePainter_.toAbsoluteCoords_(this.treePainter_.calculateBoundingRect_(h[i]));
if(c.left+j.w>b.width){c.left=0;c.top+=d+(d>0?5:0)}this.treePainter_.draw_(a,h[i],this.treePainter_.toRelativeCoords_(c));c.left+=j.w;d=Math.max(d,j.h)}}catch(k){if(k.name=="TreeCycleException")this.project_.logger().error(k);else throw k;}return false};rhizo.layout.TreeLayout.prototype.toString=function(){return"Tree"};rhizo.layout.TreeLayout.prototype.dependentModels=function(a){var b=[];if(a=this.globalNodesMap_[a]){a.deepChildsAsArray(b);for(a=b.length-1;a>=0;a--)b[a]=b[a].id}return b};
rhizo.layout.TreePainter=function(a,b){this.project_=a;if(this.vertical_=b){this.gdName_="top";this.odName_="left";this.gdLength_="height";this.odLength_="width"}else{this.gdName_="left";this.odName_="top";this.gdLength_="width";this.odLength_="height"}};rhizo.layout.TreePainter.prototype.gd_=function(a){return this.vertical_?a.height:a.width};rhizo.layout.TreePainter.prototype.od_=function(a){return this.vertical_?a.width:a.height};
rhizo.layout.TreePainter.prototype.toAbsoluteCoords_=function(a){return this.vertical_?{w:a.od,h:a.gd}:{w:a.gd,h:a.od}};rhizo.layout.TreePainter.prototype.toRelativeCoords_=function(a){return this.vertical_?{gd:a.top,od:a.left}:{gd:a.left,od:a.top}};rhizo.layout.TreePainter.prototype.packedCenter_=function(a,b){return{gd:a.gd+5+this.gd_(b)/2,od:a.od+this.od_(b)/2}};rhizo.layout.TreePainter.prototype.evenCenter_=function(a,b,c){return{gd:a.gd+c.gd/2,od:a.od+5+this.od_(b)/2}};
rhizo.layout.TreePainter.prototype.fillSyntheticRenderings_=function(a,b){if(a.synthetic()&&!a.syntheticRendering()){var c=$("<div />",{"class":"rhizo-tree-syntheticnode"}).text(a.payload()||"Everything Else");c.click(jQuery.proxy(function(){var e=[],f=[];a.deepChildsAsArray(e);for(var g=e.length-1;g>=0;g--)e[g].synthetic()||f.push(e[g].id);this.project_.toggleSelect(f)},this));b.artifact(c);a.setSyntheticRendering(new rhizo.ui.SyntheticRendering(c))}for(var d in a.childs)this.fillSyntheticRenderings_(a.childs[d],
b)};rhizo.layout.TreePainter.prototype.calculateBoundingRect_=function(a){var b={gd:0,od:0};for(var c in a.childs){var d=this.calculateBoundingRect_(a.childs[c]);b.gd+=d.gd+5;b.od=Math.max(b.od,d.od)}c=a.renderingDimensions();a.boundingRect={od:this.od_(c)+b.od+25,gd:Math.max(this.gd_(c),b.gd)+5};return a.boundingRect};
rhizo.layout.TreePainter.prototype.draw_=function(a,b,c,d,e){var f=b.renderingDimensions();if(this.vertical_){b.synthetic()?b.syntheticRendering().move(c.gd+5,c.od,true):a.move(b.payload().id,c.gd+5,c.od);d!=null&&this.drawConnector_(a,this.packedCenter_(c,f),this.packedCenter_(d,e.renderingDimensions()))}else{b.synthetic()?b.syntheticRendering().move(c.od+5,c.gd+(b.boundingRect.gd-this.gd_(f))/2,true):a.move(b.payload().id,c.od+5,c.gd+(b.boundingRect.gd-this.gd_(f))/2);d!=null&&this.drawConnector_(a,
this.evenCenter_(c,f,b.boundingRect),this.evenCenter_(d,e.renderingDimensions(),e.boundingRect))}d=c.gd;for(var g in b.childs){e=b.childs[g];var h={od:c.od+this.od_(f)+20,gd:d};this.draw_(a,e,h,c,b);d+=e.boundingRect.gd+5}};
rhizo.layout.TreePainter.prototype.drawConnector_=function(a,b,c){var d={position:"absolute"};d[this.gdName_]=Math.min(b.gd,c.gd);d[this.odName_]=c.od;d[this.odLength_]=2;d[this.gdLength_]=Math.abs(c.gd-b.gd);d=$("<div />",{"class":"rhizo-tree-connector",css:d});var e={position:"absolute"};e[this.gdName_]=b.gd;e[this.odName_]=c.od;e[this.gdLength_]=2;e[this.odLength_]=Math.abs(c.od-b.od);b=$("<div />",{"class":"rhizo-tree-connector",css:e});a.artifact(d);a.artifact(b)};rhizo.layout.layouts.tree=rhizo.layout.TreeLayout;
namespace("rhizo.ui.component");rhizo.ui.component.Progress=function(){};rhizo.ui.component.Progress.prototype.render=function(a){this.pbarPanel_=$("<div/>",{"class":"rhizo-progressbar-panel"}).appendTo(a);this.pbarPanel_.css({top:Math.round((a.height()-this.pbarPanel_.height())/2),left:Math.round((a.width()-this.pbarPanel_.width())/2)});this.pbar_=$("<div/>",{"class":"rhizo-progressbar"}).appendTo(this.pbarPanel_).progressbar({value:1});this.pbarText_=$("<div/>",{"class":"rhizo-progressbar-text"}).text("Loading...").appendTo(this.pbarPanel_)};
rhizo.ui.component.Progress.prototype.update=function(a,b){this.pbar_.progressbar("value",a);b&&this.pbarText_.text(b);a>=100&&this.destroy_()};rhizo.ui.component.Progress.prototype.destroy_=function(){this.pbarPanel_.is(":visible")?setTimeout(jQuery.proxy(function(){this.pbarPanel_.fadeOut(function(){$(this).remove()})},this),1E3):this.pbarPanel_.remove()};rhizo.ui.component.EventType={ACTIVATE:"activate",DEACTIVATE:"deactivate"};rhizo.ui.component.Phase={INIT:0,RENDER:1,METAREADY:2,READY:3};
rhizo.ui.component.Component=function(a,b,c){this.project_=a;this.gui_=a.gui();this.options_=b;(this.key_=c)&&this.gui_.addComponent(c,this)};rhizo.ui.component.Component.prototype.key=function(){return this.key_};rhizo.ui.component.Component.prototype.title=function(){return null};rhizo.ui.component.Component.prototype.titleClass=function(){return null};rhizo.ui.component.Component.prototype.onEvent=function(){};rhizo.ui.component.Component.prototype.render=function(){return $("<div />").get(0)};
rhizo.ui.component.Component.prototype.metaReady=function(){};rhizo.ui.component.Component.prototype.ready=function(){};rhizo.ui.component.Container=function(a,b,c){rhizo.ui.component.Component.call(this,a,b,c);this.components_=[];this.phase_=rhizo.ui.component.Phase.INIT};rhizo.inherits(rhizo.ui.component.Container,rhizo.ui.component.Component);
rhizo.ui.component.Container.prototype.addComponent=function(a,b){b?this.components_.splice(b,0,a):this.components_.push(a);if(b<0)b=this.components_.length-1+b;var c=null;switch(this.phase_){case rhizo.ui.component.Phase.INIT:break;case rhizo.ui.component.Phase.RENDER:c=this.renderSingleComponent(a,b);break;case rhizo.ui.component.Phase.METAREADY:c=this.renderSingleComponent(a,b);a.metaReady();break;case rhizo.ui.component.Phase.READY:c=this.renderSingleComponent(a,b);a.metaReady();a.ready();break;
default:break}return c};rhizo.ui.component.Container.prototype.getComponents=function(){return this.components_};rhizo.ui.component.Container.prototype.phase=function(){return this.phase_};rhizo.ui.component.Container.prototype.render=function(){this.phase_=rhizo.ui.component.Phase.RENDER;var a=[];this.appendRendering_(this.renderContainer(),a);for(var b=0;b<this.components_.length;b++)this.appendRendering_(this.renderSingleComponent(this.components_[b],b),a);return a};
rhizo.ui.component.Container.prototype.appendRendering_=function(a,b){if(a)jQuery.isArray(a)?Array.prototype.push.apply(b,a):b.push(a)};rhizo.ui.component.Container.prototype.renderContainer=function(){return null};rhizo.ui.component.Container.prototype.renderSingleComponent=function(){return null};rhizo.ui.component.Container.prototype.metaReady=function(){this.phase_=rhizo.ui.component.Phase.METAREADY;for(var a=this.getComponents(),b=0;b<a.length;b++)a[b].metaReady()};
rhizo.ui.component.Container.prototype.ready=function(){this.phase_=rhizo.ui.component.Phase.READY;for(var a=this.getComponents(),b=0;b<a.length;b++)a[b].ready()};rhizo.ui.component.Template=function(a,b,c){rhizo.ui.component.Container.call(this,a,b,c);this.viewport_=new rhizo.ui.component.Viewport(a,b);this.progress_=new rhizo.ui.component.Progress};rhizo.inherits(rhizo.ui.component.Template,rhizo.ui.component.Container);
rhizo.ui.component.Template.prototype.setProgressHandler=function(a){this.progress_=a};rhizo.ui.component.Template.prototype.addComponent=function(a){(a=rhizo.ui.component.Container.prototype.addComponent.call(this,a))&&this.gui_.container.append(a)};rhizo.ui.component.Template.prototype.render=function(){var a=rhizo.ui.component.Container.prototype.render.call(this);this.progress_&&this.progress_.update(20,"Chrome created. Loading metadata...");return a};
rhizo.ui.component.Template.prototype.renderContainer=function(){this.gui_.container.addClass("rhizo-template-"+this.key());this.gui_.container.append(this.viewport_.render());this.progress_&&this.progress_.render(this.gui_.viewport);return this.gui_.container.get(0)};rhizo.ui.component.Template.prototype.renderSingleComponent=function(a){this.gui_.container.append(a.render());return null};
rhizo.ui.component.Template.prototype.metaReady=function(){this.progress_&&this.progress_.update(40,"Metadata loaded. Updating components...");this.viewport_.metaReady();rhizo.ui.component.Container.prototype.metaReady.call(this);this.progress_&&this.progress_.update(60,"Components updated. Loading models...")};
rhizo.ui.component.Template.prototype.ready=function(){this.progress_&&this.progress_.update(80,"Models loaded. Activating UI...");this.viewport_.ready();rhizo.ui.component.Container.prototype.ready.call(this);this.progress_&&this.progress_.update(100,"Rhizosphere ready!")};rhizo.ui.component.VBox=function(a,b,c,d){rhizo.ui.component.Container.call(this,a,b,c);this.boxclass_=d;this.panel_=null};rhizo.inherits(rhizo.ui.component.VBox,rhizo.ui.component.Container);
rhizo.ui.component.VBox.prototype.renderContainer=function(){this.panel_=$("<div />",{"class":this.boxclass_});return this.panel_.get(0)};rhizo.ui.component.VBox.prototype.renderSingleComponent=function(a){var b=a.title();if(b){var c="rhizo-section-header";if(a.titleClass())c+=" "+a.titleClass();$("<div />",{"class":c}).text(b).appendTo(this.panel_)}this.panel_.append(a.render());return null};
rhizo.ui.component.RightBar=function(a,b,c,d){rhizo.ui.component.Container.call(this,a,b,c);this.boxclass_=d};rhizo.inherits(rhizo.ui.component.RightBar,rhizo.ui.component.Container);rhizo.ui.component.RightBar.prototype.renderContainer=function(){this.toggle_=$("<div />",{"class":"rhizo-right-pop"}).html("&#x25c2;");this.rightBar_=$("<div />",{"class":this.boxclass_}).css("display","none");this.activateToggle_();return[this.rightBar_.get(0),this.toggle_.get(0)]};
rhizo.ui.component.RightBar.prototype.renderSingleComponent=function(a){var b=a.title();if(b){var c="rhizo-section-header";if(a.titleClass())c+=" "+a.titleClass();$("<div />",{"class":c}).text(b).appendTo(this.rightBar_)}this.rightBar_.append(a.render());return null};
rhizo.ui.component.RightBar.prototype.activateToggle_=function(){this.toggle_.click(jQuery.proxy(function(){if(this.rightBar_.is(":visible")){this.toggle_.css("right",0).html("&#x25c2;");this.gui_.viewport.css("right",5);this.rightBar_.css("display","none")}else{this.gui_.viewport.css("right",135);this.toggle_.css("right",130).html("&#x25b8;");this.rightBar_.css("display","")}},this))};rhizo.ui.component.RightBar.prototype.getToggle=function(){return this.toggle_};
rhizo.ui.component.RightBar.prototype.isCollapsed=function(){return this.rightBar_.is(":visible")};rhizo.ui.component.HBox=function(a,b,c,d){rhizo.ui.component.Container.call(this,a,b,c,d);this.toggles_=[];this.boxclass_=d};rhizo.inherits(rhizo.ui.component.HBox,rhizo.ui.component.Container);rhizo.ui.component.HBox.prototype.renderContainer=function(){this.bar_=$("<div />",{"class":this.boxclass_});return this.bar_.get(0)};
rhizo.ui.component.HBox.prototype.renderSingleComponent=function(a,b){var c={component:a,key:a.key(),clickable:this.renderClickable_(a.title(),a.titleClass()),renderings:a.render()};this.toggles_.push(c);if(b)b>0?c.clickable.insertAfter(this.bar_.find(".rhizo-section-header:eq("+(b-1)+")")):this.bar_.prepend(c.clickable);else this.bar_.append(c.clickable);$(c.renderings).addClass("rhizo-floating-panel").css("display","none");this.activateToggle_(c);return $(c.renderings).get()};
rhizo.ui.component.HBox.prototype.renderClickable_=function(a,b){var c="rhizo-section-header";if(b)c+=" "+b;c=$("<div />",{"class":c}).appendTo(this.bar_);$("<a />",{href:"javascript:;",title:a}).text(a).appendTo(c);return c};
rhizo.ui.component.HBox.prototype.activateToggle_=function(a){a.clickable.click(jQuery.proxy(function(){jQuery.each(this.toggles_,jQuery.proxy(function(b,c){if(c==a){$(c.renderings).toggle();$(c.clickable).toggleClass("rhizo-section-open")}else{$(c.renderings).css("display","none");$(c.clickable).removeClass("rhizo-section-open")}if(this.phase()==rhizo.ui.component.Phase.READY)c.component.onEvent($(c.clickable).hasClass("rhizo-section-open")?rhizo.ui.component.EventType.ACTIVATE:rhizo.ui.component.EventType.DEACTIVATE)},
this))},this))};rhizo.ui.component.HBox.prototype.toggleComponent=function(a,b){for(var c=0;c<this.toggles_.length;c++)if(this.toggles_[c].key==a){this.toggles_[c].clickable.hasClass("rhizo-section-open")!=b&&this.toggles_[c].clickable.click();break}};rhizo.ui.component.Viewport=function(a,b){rhizo.ui.component.Component.call(this,a,b);this.universeTargetPosition_={top:0,left:0}};rhizo.inherits(rhizo.ui.component.Viewport,rhizo.ui.component.Component);
rhizo.ui.component.Viewport.prototype.render=function(){this.viewport_=$("<div/>",{"class":"rhizo-viewport"});this.universe_=$("<div/>",{"class":"rhizo-universe"}).appendTo(this.viewport_);this.gui_.setViewport(this.viewport_);this.gui_.setUniverse(this.universe_);return this.viewport_.get(0)};
rhizo.ui.component.Viewport.prototype.ready=function(){this.viewport_.draggable({cancel:".rhizo-model",helper:jQuery.proxy(function(){return $("<div />").appendTo(this.viewport_)},this),start:jQuery.proxy(function(){var a=this.universe_.position();this.universe_.data("top0",a.top).data("left0",a.left)},this),drag:jQuery.proxy(function(a,b){var c=b.position.top+this.universe_.data("top0"),d=b.position.left+this.universe_.data("left0");if(Math.abs(b.position.left)<=15)d=this.universe_.data("left0");
if(Math.abs(d)<=15)d=0;this.moveUniverse_({top:c,left:d})},this),refreshPositions:false});$.support.mouseWheel&&this.viewport_.mousewheel(jQuery.proxy(function(a,b,c){this.panUniverse_(b,c)},this))};rhizo.ui.component.Viewport.prototype.moveUniverse_=function(a){this.universeTargetPosition_={top:a.top,left:a.left};this.universe_.stop().css(this.universeTargetPosition_)};
rhizo.ui.component.Viewport.prototype.panUniverse_=function(a,b){var c=Math.round(this.viewport_.get(0).offsetHeight/10);this.universeTargetPosition_={top:b*c+this.universeTargetPosition_.top,left:a*c+this.universeTargetPosition_.left};this.universe_.stop().animate(this.universeTargetPosition_)};rhizo.ui.component.Logo=function(a,b,c,d){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.Logo");this.titleless_=c;this.sliding_=d};rhizo.inherits(rhizo.ui.component.Logo,rhizo.ui.component.Component);
rhizo.ui.component.Logo.prototype.title=function(){return this.titleless_?null:"?"};
rhizo.ui.component.Logo.prototype.render=function(){var a=$("<div />",{"class":"rhizo-logo"}),b=$("<h1>Rhizosphere</h1>").appendTo(a),c=$("<p />").appendTo(a);c.append($("<a />",{href:"http://www.rhizospherejs.com/doc",target:"_blank"}).text("Help"));c.append("&nbsp;").append($("<a />",{href:"http://sites.google.com/site/rhizosphereui/",target:"_blank"}).text("Project Info"));c.append("&nbsp;").append($("<a />",{href:"http://rhizosphere.googlecode.com/hg/AUTHORS.txt",target:"_blank"}).text("Authors"));
c.append("&nbsp;").append($("<a />",{href:"http://rhizosphere.googlecode.com/hg/COPYING.txt",target:"_blank"}).text("License"));this.sliding_&&b.click(function(){c.slideToggle("fast")});return a.get(0)};rhizo.ui.component.Console=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.Console")};rhizo.inherits(rhizo.ui.component.Console,rhizo.ui.component.Component);
rhizo.ui.component.Console.prototype.render=function(){this.toggleButton_=$("<div />",{"class":"rhizo-console-close"}).html("&#8659;");this.consoleHeader_=$("<div />",{"class":"rhizo-console-header"});this.consoleHeader_.append(this.toggleButton_).append("Log Console");this.consoleContents_=$("<div />",{"class":"rhizo-console-contents"});this.activate_();return[this.consoleHeader_.get(0),this.consoleContents_.get(0)]};
rhizo.ui.component.Console.prototype.activate_=function(){this.toggleButton_.click(jQuery.proxy(function(){this.consoleContents_.is(":visible")?this.consoleContents_.slideUp("slow",jQuery.proxy(function(){this.toggleButton_.html("&#8659;");this.consoleContents_.empty()},this)):this.consoleContents_.slideDown("slow",jQuery.proxy(function(){this.toggleButton_.html("&#8657;")},this))},this))};rhizo.ui.component.Console.prototype.getContents=function(){return this.consoleContents_};
rhizo.ui.component.Console.prototype.getHeader=function(){return this.consoleHeader_};rhizo.ui.component.Layout=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.Layout")};rhizo.inherits(rhizo.ui.component.Layout,rhizo.ui.component.Component);rhizo.ui.component.Layout.prototype.title=function(){return"Display"};
rhizo.ui.component.Layout.prototype.render=function(){this.layoutPanel_=$("<div />");this.layoutOptions_=$("<div />",{"class":"rhizo-layout-extra-options"}).appendTo(this.layoutPanel_);this.layoutSelector_=$("<select />",{disabled:"disabled"});this.layoutSelector_.append($("<option value=''>No layout engines</option>"));this.submit_=$("<button />",{disabled:"disabled"}).text("Update");this.layoutPanel_.prepend(this.submit_).prepend(this.layoutSelector_).prepend("Keep items ordered by: ");return this.layoutPanel_.get(0)};
rhizo.ui.component.Layout.prototype.metaReady=function(){this.layoutSelector_.children().remove();var a={},b=this.project_.layoutEngines();for(var c in b){var d=b[c];this.layoutSelector_.append($("<option value='"+c+"' "+(this.project_.currentLayoutEngineName()==c?"selected":"")+">"+d+"</option>"));if(d.layoutUIControls){d=d.layoutUIControls();a[c]=$(d);this.project_.currentLayoutEngineName()!=c&&d.css("display","none");this.layoutOptions_.append(d)}}this.layoutSelector_.removeAttr("disabled").change(function(){for(var e in a)e==
$(this).val()?a[e].show("fast"):a[e].hide("fast")})};rhizo.ui.component.Layout.prototype.ready=function(){this.submit_.removeAttr("disabled").click(jQuery.proxy(function(){this.project_.layout(this.layoutSelector_.val(),null,{forcealign:true})},this))};rhizo.ui.component.Layout.prototype.setEngine=function(a){this.layoutSelector_.val(a).change()};rhizo.ui.component.SelectionManager=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.SelectionManager")};
rhizo.inherits(rhizo.ui.component.SelectionManager,rhizo.ui.component.Component);rhizo.ui.component.SelectionManager.prototype.title=function(){return"Selection"};rhizo.ui.component.SelectionManager.prototype.onEvent=function(a){a=a==rhizo.ui.component.EventType.ACTIVATE;this.gui_.isSelectionModeOn()!=a&&this.gui_.toggleSelectionMode()};
rhizo.ui.component.SelectionManager.prototype.render=function(){var a=$("<div />",{"class":"rhizo-selection"});this.selection_trigger_=$("<div />",{"class":"rhizo-selection-trigger",title:"Start selecting items"}).appendTo(this.gui_.viewport);this.selectButton_=$("<button />",{disabled:"disabled"}).text("Work on selected items only");this.resetButton_=$("<button />",{disabled:"disabled"}).text("Reset");a.append(this.selectButton_).append(this.resetButton_);return a.get(0)};
rhizo.ui.component.SelectionManager.prototype.ready=function(){this.activateSelectableViewport_();this.activateButtons_()};rhizo.ui.component.SelectionManager.prototype.activateButtons_=function(){this.selectButton_.removeAttr("disabled").click(jQuery.proxy(function(){this.setNumFilteredModels(this.project_.filterUnselected())},this));this.resetButton_.click(jQuery.proxy(function(){this.project_.resetUnselected();this.setNumFilteredModels(0)},this))};
rhizo.ui.component.SelectionManager.prototype.isOnEmptySpace_=function(a){return $(a.target).hasClass("rhizo-viewport")||$(a.target).hasClass("rhizo-universe")};
rhizo.ui.component.SelectionManager.prototype.activateSelectableViewport_=function(){var a=this.project_;this.selection_trigger_.click(function(){a.gui().toggleSelectionMode()});this.gui_.viewport.selectable({disabled:true,selected:function(b,c){var d=$(c.selected).data("id");d&&a.select(d)},unselected:function(b,c){var d=$(c.unselected).data("id");d&&a.unselect(d)},filter:this.options_.selectfilter,tolerance:"touch",distance:1});this.gui_.viewport.click(jQuery.proxy(function(b){this.isOnEmptySpace_(b)&&
a.unselectAll()},this))};rhizo.ui.component.SelectionManager.prototype.toggleSelectionTrigger=function(a){this.selection_trigger_.attr("title",a?"Stop selecting items":"Start selecting items")};rhizo.ui.component.SelectionManager.prototype.setNumFilteredModels=function(a){a>0?this.resetButton_.removeAttr("disabled").text("Reset ("+a+" filtered)"):this.resetButton_.attr("disabled","disabled").text("Reset")};
rhizo.ui.component.AutocommitPanel=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.AutocommitPanel");this.callback_=null};rhizo.inherits(rhizo.ui.component.AutocommitPanel,rhizo.ui.component.Component);rhizo.ui.component.AutocommitPanel.prototype.registerCallback=function(a){this.callback_=a};
rhizo.ui.component.AutocommitPanel.prototype.render=function(){var a=$("<div />",{"class":"rhizo-filter rhizo-autocommit-panel"});this.autocommit_=$("<input />",{type:"checkbox",checked:this.project_.isFilterAutocommit(),disabled:"disabled"}).appendTo(a);this.autocommitLabel_=$("<span>Autocommit</span>").appendTo(a);this.hideButton_=$("<button />",{disabled:"disabled"}).text("Apply filters").appendTo(a);return a};
rhizo.ui.component.AutocommitPanel.prototype.ready=function(){this.autocommit_.removeAttr("disabled").click(jQuery.proxy(function(){this.setAutocommit_(this.autocommit_.is(":checked"))},this));this.autocommitLabel_.click(jQuery.proxy(function(){if(this.autocommit_.is(":checked")){this.autocommit_.removeAttr("checked");this.setAutocommit_(false)}else{this.autocommit_.attr("checked","checked");this.setAutocommit_(true)}},this));this.hideButton_.attr("disabled",this.project_.isFilterAutocommit()).click(jQuery.proxy(function(){this.project_.commitFilter()},
this))};rhizo.ui.component.AutocommitPanel.prototype.setAutocommit_=function(a){a?this.hideButton_.attr("disabled","disabled"):this.hideButton_.removeAttr("disabled");this.callback_&&this.callback_(a);this.project_.enableFilterAutocommit(a)};rhizo.ui.component.FilterStackContainer=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.FilterStackContainer");this.autocommitPanel_=new rhizo.ui.component.AutocommitPanel(a,b);this.filterSelectorThreshold_=5;this.activeFilters_={}};
rhizo.inherits(rhizo.ui.component.FilterStackContainer,rhizo.ui.component.Component);rhizo.ui.component.FilterStackContainer.prototype.title=function(){return"Filters"};rhizo.ui.component.FilterStackContainer.prototype.render=function(){this.filterPanel_=$("<div />",{"class":"rhizo-filter-container"});this.filterPanel_.append(this.autocommitPanel_.render());this.noFilterNotice_=$("<p />").text("No filters available.");this.filterPanel_.append(this.noFilterNotice_);return this.filterPanel_.get(0)};
rhizo.ui.component.FilterStackContainer.prototype.metaReady=function(){var a=this.project_.metaModel(),b=0;for(var c in a)b++;b>0&&this.noFilterNotice_.remove();if(b<=this.filterSelectorThreshold_)for(c in a)this.filterPanel_.append(a[c].kind.renderFilter(this.project_,a[c],c));else this.renderFilterSelector_()};
rhizo.ui.component.FilterStackContainer.prototype.renderFilterSelector_=function(){var a=this.project_.metaModel();this.filterSelector_=$("<select />",{"class":"rhizo-filter-selector",disabled:"disabled"});$("<option />").attr("value","").text("More filters...").appendTo(this.filterSelector_);for(var b in a)this.filterSelector_.append($("<option />").attr("value",b).text(a[b].label));this.filterPanel_.append(this.filterSelector_);var c=0;for(b in a){this.activateFilter_(b);if(++c==this.filterSelectorThreshold_)break}};
rhizo.ui.component.FilterStackContainer.prototype.ready=function(){this.autocommitPanel_.ready();this.filterSelector_&&this.activateFilterSelector_()};rhizo.ui.component.FilterStackContainer.prototype.activateFilterSelector_=function(){this.filterSelector_.removeAttr("disabled").change(jQuery.proxy(function(){var a=this.filterSelector_.val();if(a in this.project_.metaModel()){this.activateFilter_(a,this.project_);this.filterSelector_.find("option").eq(0).attr("selected","selected")}},this))};
rhizo.ui.component.FilterStackContainer.prototype.activateFilter_=function(a){var b=this.project_.metaModel(),c=b[a].kind.renderFilter(this.project_,b[a],a);this.activeFilters_[a]=true;$("<div />",{"class":"rhizo-icon rhizo-close-icon"}).text("x").prependTo(c).click(jQuery.proxy(function(){c.remove();delete this.activeFilters_[a];this.project_.filter(a,null);this.filterSelector_.find("option[value="+rhizo.util.escapeSelectorToken(a)+"]").removeAttr("disabled")},this));c.appendTo(this.filterPanel_);
this.filterSelector_.find("option[value="+rhizo.util.escapeSelectorToken(a)+"]").attr("disabled","disabled")};rhizo.ui.component.FilterStackContainer.prototype.isFilterActive=function(a){if(!this.filterSelector_)return true;return a in this.activeFilters_};rhizo.ui.component.FilterStackContainer.prototype.showFilter=function(a){if(this.filterSelector_)a in this.activeFilters_||this.activateFilter_(a)};
rhizo.ui.component.FilterBookContainer=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.FilterBookContainer");this.autocommitPanel_=new rhizo.ui.component.AutocommitPanel(a,b)};rhizo.inherits(rhizo.ui.component.FilterBookContainer,rhizo.ui.component.Component);rhizo.ui.component.FilterBookContainer.prototype.title=function(){return"Filters"};
rhizo.ui.component.FilterBookContainer.prototype.render=function(){this.filterPanel_=$("<div />",{"class":"rhizo-filter-container"});this.nextFilter_=$("<div />",{"class":"rhizo-next-filter",title:"Next filter"}).text(">").appendTo(this.filterPanel_);this.prevFilter_=$("<div />",{"class":"rhizo-prev-filter",title:"Previous filter"}).text("<").appendTo(this.filterPanel_);this.commitFilterLink_=$("<a />",{href:"javascript:;","class":"rhizo-autocommit-link"}).text("Apply").appendTo(this.filterPanel_);
this.filterPanel_.append(this.autocommitPanel_.render());return this.filterPanel_.get(0)};rhizo.ui.component.FilterBookContainer.prototype.metaReady=function(){this.project_.isFilterAutocommit()&&this.commitFilterLink_.css("display","none");this.autocommitPanel_.registerCallback(jQuery.proxy(function(d){this.commitFilterLink_.css("display",d?"none":"")},this));var a=this.project_.metaModel();for(var b in a){var c=a[b].kind.renderFilter(this.project_,a[b],b);c.css("display","none");this.filterPanel_.append(c)}};
rhizo.ui.component.FilterBookContainer.prototype.ready=function(){this.autocommitPanel_.ready();this.commitFilterLink_.click(jQuery.proxy(function(){this.project_.commitFilter()},this));var a=this.gui_;this.nextFilter_.click(function(){var b=$(".rhizo-filter:visible",a.container),c=b.next(".rhizo-filter:hidden").eq(0);if(c.length>0){b.css("display","none");c.css("display","")}});this.prevFilter_.click(function(){var b=$(".rhizo-filter:visible",a.container),c=b.prev(".rhizo-filter:hidden").eq(0);if(c.length>
0){b.css("display","none");c.css("display","")}})};rhizo.ui.component.Legend=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.ui.component.Legend");this.legendPanel_=null};rhizo.inherits(rhizo.ui.component.Legend,rhizo.ui.component.Component);rhizo.ui.component.Legend.prototype.title=function(){return"Legend"};
rhizo.ui.component.Legend.prototype.render=function(){this.legendPanel_=$("<div />",{"class":"rhizo-legend-panel"});$("<p />").text("Legend is not available yet.").appendTo(this.legendPanel_);return this.legendPanel_.get(0)};
rhizo.ui.component.Legend.prototype.metaReady=function(){if(this.project_.renderer().getSizeRange||this.project_.renderer().getColorRange){this.legendPanel_.children().remove();var a=null;if(this.project_.renderer().getSizeRange)a=this.project_.renderer().getSizeRange();var b=null;if(this.project_.renderer().getColorRange)b=this.project_.renderer().getColorRange();if(a){var c=$("<div />",{"class":"rhizo-legend-size"}),d=$("<span />",{"class":"rhizo-legend-size-min"}).html(a.label+" &nbsp; "+rhizo.ui.toHumanLabel(a.min)+
":");a=$("<span />",{"class":"rhizo-legend-size-max"}).html(": "+rhizo.ui.toHumanLabel(a.max));c.append(d).append('<span class="ar-fon-0">A</span> -- <span class="ar-fon-5">A</span>').append(a).appendTo(this.legendPanel_)}if(b){c=$("<div />",{"class":"rhizo-legend-color"});d=$("<span />",{"class":"rhizo-legend-color-min"}).html(b.label+" &nbsp; "+rhizo.ui.toHumanLabel(b.min)+":");a=$("<span />",{"class":"rhizo-legend-color-max"}).html(": "+rhizo.ui.toHumanLabel(b.max));c.append(d).append('<span class="ar-col-0 ar-col-legend">&nbsp; &nbsp;</span>&nbsp;<span class="ar-col-1 ar-col-legend">&nbsp; &nbsp;</span>&nbsp;<span class="ar-col-2 ar-col-legend">&nbsp; &nbsp;</span>&nbsp;<span class="ar-col-3 ar-col-legend">&nbsp; &nbsp;</span>&nbsp;<span class="ar-col-4 ar-col-legend">&nbsp; &nbsp;</span>&nbsp;<span class="ar-col-5 ar-col-legend">&nbsp; &nbsp;</span>&nbsp;').append(a).appendTo(this.legendPanel_)}}};
rhizo.ui.component.Actions=function(a,b){rhizo.ui.component.Component.call(this,a,b)};rhizo.inherits(rhizo.ui.component.Actions,rhizo.ui.component.Component);rhizo.ui.component.Actions.prototype.title=function(){return"Actions"};rhizo.ui.component.Actions.prototype.render=function(){for(var a=$("<div />",{"class":"rhizo-actions"}),b=0;b<2;b++)$("<div />",{"class":"rhizo-action"}).text("Sample Action "+(b+1)).appendTo(a);return a.get(0)};
rhizo.ui.component.Actions.prototype.ready=function(){if($(".rhizo-action",this.gui_.container).length>0){var a=this.gui_,b=this.project_;$(".rhizo-action",this.gui_.container).draggable({helper:"clone"});this.gui_.universe.droppable({accept:".rhizo-action",drop:function(c,d){var e=a.universe.offset(),f=a.universe.width(),g=a.universe.height(),h=d.draggable.text(),i=d.offset.left-e.left;if(i+200>f)i=f-210;e=d.offset.top-e.top;if(e+200>g)e=g-210;var j=$("<div class='rhizo-droppable-action'>Drop your items here to perform:<br />"+
h+"</div>").css({top:e,left:i});a.universe.append(j);j.fadeIn();j.draggable();j.droppable({accept:".rhizo-model",drop:function(k,n){var m=n.draggable.data("id");if(b.isSelected(m)){var p=0,l=b.allSelected();for(m in l)p++;alert("Action applied on "+p+" elements");for(m in l)l[m].rendering().moveToMark().unmarkPosition();b.unselectAll()}else{alert("Action applied on "+b.model(m));b.model(m).rendering().moveToMark().unmarkPosition()}}});j.dblclick(function(){j.remove();return false})}})}};
rhizo.ui.component.BottomTemplate=function(a,b,c){rhizo.ui.component.Template.call(this,a,b,c);this.initComponents_(a,b)};rhizo.inherits(rhizo.ui.component.BottomTemplate,rhizo.ui.component.Template);
rhizo.ui.component.BottomTemplate.prototype.initComponents_=function(a,b){this.hbox_=new rhizo.ui.component.HBox(a,b,"rhizo.ui.component.BottomBar","rhizo-bottom-bar");for(var c=this.defaultComponents(a,b),d=0;d<c.length;d++)this.hbox_.addComponent(c[d]);rhizo.ui.component.Template.prototype.addComponent.call(this,this.hbox_)};
rhizo.ui.component.BottomTemplate.prototype.defaultComponents=function(a,b){return[new rhizo.ui.component.Layout(a,b),new rhizo.ui.component.SelectionManager(a,b),new rhizo.ui.component.FilterBookContainer(a,b),new rhizo.ui.component.Logo(a,b,false,false)]};rhizo.ui.component.BottomTemplate.prototype.addComponent=function(a){this.addtoBottomBar(a);return null};rhizo.ui.component.BottomTemplate.prototype.addtoBottomBar=function(a){(a=this.hbox_.addComponent(a,-1))&&this.gui_.container.append(a)};
rhizo.ui.component.StandardTemplate=function(a,b,c){rhizo.ui.component.Template.call(this,a,b,c);this.initComponents_(a,b)};rhizo.inherits(rhizo.ui.component.StandardTemplate,rhizo.ui.component.Template);
rhizo.ui.component.StandardTemplate.prototype.initComponents_=function(a,b){this.leftbox_=new rhizo.ui.component.VBox(a,b,null,"rhizo-left");this.rightbox_=new rhizo.ui.component.RightBar(a,b,"rhizo.ui.component.RightBar","rhizo-right");for(var c=this.defaultLeftComponents(a,b),d=0;d<c.length;d++)this.leftbox_.addComponent(c[d]);c=this.defaultRightComponents(a,b);for(d=0;d<c.length;d++)this.rightbox_.addComponent(c[d]);rhizo.ui.component.Template.prototype.addComponent.call(this,this.leftbox_);rhizo.ui.component.Template.prototype.addComponent.call(this,
this.rightbox_)};rhizo.ui.component.StandardTemplate.prototype.defaultLeftComponents=function(a,b){return[new rhizo.ui.component.Logo(a,b,true,true),new rhizo.ui.component.Layout(a,b),new rhizo.ui.component.SelectionManager(a,b),new rhizo.ui.component.FilterStackContainer(a,b)]};rhizo.ui.component.StandardTemplate.prototype.defaultRightComponents=function(a,b){return[new rhizo.ui.component.Console(a,b),new rhizo.ui.component.Actions(a,b)]};
rhizo.ui.component.StandardTemplate.prototype.addComponent=function(a){this.addtoLeftBar(a);return null};rhizo.ui.component.StandardTemplate.prototype.addtoLeftBar=function(a){(a=this.leftbox_.addComponent(a))&&this.gui_.container.append(a)};rhizo.ui.component.StandardTemplate.prototype.addToRightBar=function(a){(a=this.rightbox_.addComponent(a))&&this.gui_.container.append(a)};
rhizo.ui.component.templates={bottom:function(a,b){return new rhizo.ui.component.BottomTemplate(a,b,"bottom")},"default":function(a,b){return new rhizo.ui.component.StandardTemplate(a,b,"default")}};namespace("rhizo.layout");namespace("rhizo.layout.treemap");rhizo.layout.treemap.TreeMapDirection={HOR:"h",VER:"v"};
rhizo.layout.treemap.TreeMapNode=function(a,b,c,d){this.id=a.id;this.pipeline_=b;this.project_=c;this.area_=a.area*d;if(isNaN(this.area_)||this.area_<0)this.area_=0;this.height_=this.width_=this.left_=this.top_=0;if(this.synthetic_=a.synthetic()){this.buildSyntheticRendering_(a);this.hidden_=false}else this.model_=a.payload()};
rhizo.layout.treemap.TreeMapNode.prototype.buildSyntheticRendering_=function(a){var b=$("<div />",{"class":"rhizo-treemap-syntheticnode"}).text(a.payload()||"Everything Else");b.click(jQuery.proxy(function(){var c=[],d=[];a.deepChildsAsArray(c);for(var e=c.length-1;e>=0;e--)c[e].synthetic()||d.push(c[e].id);this.project_.toggleSelect(d)},this));this.pipeline_.artifact(b);this.syntheticRendering_=new rhizo.ui.SyntheticRendering(b);a.setSyntheticRendering(this.syntheticRendering_)};
rhizo.layout.treemap.TreeMapNode.prototype.area=function(){return this.area_};rhizo.layout.treemap.TreeMapNode.prototype.isHidden=function(){return this.synthetic_?this.hidden_:this.model_.isFiltered("__treemap__")};rhizo.layout.treemap.TreeMapNode.prototype.hide=function(){if(this.synthetic_)this.hidden_=true;else this.model_.filter("__treemap__")};
rhizo.layout.treemap.TreeMapNode.prototype.nestedBoundingRect=function(){return this.isHidden()||this.width_<24||this.height_<39?{width:0,height:0}:{width:this.width_-4,height:this.height_-19}};rhizo.layout.treemap.TreeMapNode.prototype.nestedAnchor=function(){return{x:this.left_+2,y:this.top_+17}};
rhizo.layout.treemap.TreeMapNode.prototype.move=function(a,b,c){this.top_=Math.round(a);this.left_=Math.round(b);if(this.synthetic_){this.syntheticRendering_.move(this.top_,this.left_,true);this.syntheticRendering_.pushElevation("__treemap__",c)}else this.pipeline_.move(this.id,this.top_,this.left_,"__treemap__",c)};
rhizo.layout.treemap.TreeMapNode.prototype.resize=function(a,b){if(this.synthetic_){if(!this.syntheticRendering_.canRescaleTo(a,b))return false;this.width_=a;this.height_=b;return this.syntheticRendering_.rescaleRendering(a,b)}else if(this.model_.rendering().canRescaleTo(a,b)){this.pipeline_.resize(this.id,a,b);this.width_=a;this.height_=b;return true}return false};
rhizo.layout.treemap.TreeMapNode.prototype.colorWeighted=function(a){if(!this.synthetic_){var b=parseFloat(this.model_.unwrap()[a.meta]);isNaN(b)||this.pipeline_.style(this.id,{backgroundColor:this.toColorScale_(b,a)})}};rhizo.layout.treemap.TreeMapNode.prototype.color=function(a){this.synthetic_||this.pipeline_.style(this.id,{backgroundColor:a})};
rhizo.layout.treemap.TreeMapNode.prototype.updateColorRange=function(a){if(!this.synthetic_){var b=parseFloat(this.model_.unwrap()[a.meta]);if(!isNaN(b)){a.min=Math.min(a.min,b);a.max=Math.max(a.max,b)}}};
rhizo.layout.treemap.TreeMapNode.prototype.toColorScale_=function(a,b){for(var c=b.kind.toFilterScale?jQuery.proxy(b.kind.toFilterScale,b.kind):function(h){return h},d=["r","g","b"],e={},f=0;f<d.length;f++){var g=d[f];e[g]=b.colorMin[g]+(b.colorMax[g]-b.colorMin[g])*(c(a)-c(b.min))/(c(b.max)-c(b.min))}return"rgb("+Math.round(e.r)+","+Math.round(e.g)+","+Math.round(e.b)+")"};
rhizo.layout.treemap.TreeMapSlice=function(a,b,c){this.length_=a;this.direction_=b;this.anchorPoint_=c;this.nodes_=[];this.sliceArea_=0;this.minArea_=Number.MAX_VALUE};rhizo.layout.treemap.TreeMapSlice.prototype.direction=function(){return this.direction_};rhizo.layout.treemap.TreeMapSlice.prototype.anchorPoint=function(){return this.anchorPoint_};rhizo.layout.treemap.TreeMapSlice.prototype.nodes=function(){return this.nodes_};
rhizo.layout.treemap.TreeMapSlice.prototype.addNode=function(a){this.nodes_.push(a);this.sliceArea_+=a.area();this.minArea_=Math.min(this.minArea_,a.area())};rhizo.layout.treemap.TreeMapSlice.prototype.span=function(a){return a?(this.sliceArea_+a.area())/this.length_:this.sliceArea_/this.length_};rhizo.layout.treemap.TreeMapSlice.prototype.aspectRatio=function(a){var b=this.span(a),c=null;c=a?Math.min(this.minArea_,a.area())/(1*b*b):this.minArea_/(1*b*b);if(c<1)c=1/c;return c};
rhizo.layout.treemap.TreeMapSlice.prototype.draw=function(a,b){a=a||{x:0,y:0};for(var c=0,d=this.anchorPoint_.y+a.y,e=this.anchorPoint_.x+a.x,f=0;f<this.nodes_.length;f++){var g=this.nodes_[f];if(g.isHidden())c++;else{var h=Math.round(this.span()),i=g.area()/this.span();if(Math.round(i)==0||h==0){g.hide();c++}else{var j={};if(this.direction_==rhizo.layout.treemap.TreeMapDirection.HOR){j.width=Math.round(i);j.height=h}else{j.width=h;j.height=Math.round(i)}if(g.resize(j.width,j.height))g.move(d,e,b);
else{g.hide();c++}}if(this.direction_==rhizo.layout.treemap.TreeMapDirection.HOR)e+=i;else d+=i}}return c};rhizo.layout.TreeMapLayout=function(a){this.project_=a;this.prevColorMeta_=null;this.globalNodesMap_={};this.numHiddenModels_=0;this.parentMatcher_=rhizo.layout.orMatcher(rhizo.layout.linkMatcher,rhizo.layout.hierarchyMatcher);rhizo.layout.GUILayout.call(this,a,new rhizo.layout.TreeMapLayoutUI(this,a))};rhizo.inherits(rhizo.layout.TreeMapLayout,rhizo.layout.GUILayout);
rhizo.layout.TreeMapLayout.prototype.verifyMetaModel=function(a){for(var b in a)if(rhizo.layout.numericMatcher(b,a[b]))return true;return false};rhizo.layout.TreeMapLayout.prototype.defaultState_=function(){return{area:rhizo.layout.firstMetamodelKey(this.project_,rhizo.layout.numericMatcher),color:null,parentKey:null}};
rhizo.layout.TreeMapLayout.prototype.validateState_=function(a){if(!this.validateStateAttributePresence_(a,"area"))return false;if(!this.validateMetamodelPresence_(a.area,rhizo.layout.numericMatcher))return false;if(a.color&&!this.validateMetamodelPresence_(a.color,rhizo.layout.numericMatcher))return false;if(a.parentKey&&!this.validateMetamodelPresence_(a.parentKey,this.parentMatcher_))return false;return true};
rhizo.layout.TreeMapLayout.prototype.layout=function(a,b,c,d,e){var f=this.getState().area,g=this.getState().color,h=this.getState().parentKey;a.backupManager().restore(c,this.prevColorMeta_&&!g);this.prevColorMeta_=g;this.revertExpandedModels_(c);var i;this.globalNodesMap_={};if(h)try{i=(new rhizo.layout.newTreeifier(h,e[h])).buildTree(c,d,this.globalNodesMap_)}catch(j){if(j.name=="TreeCycleException"){this.project_.logger().error(j);return false}else throw j;}else{i=new rhizo.layout.TreeNode;for(d=
0;d<c.length;d++)i.addChild(new rhizo.layout.ModelTreeNode(c[d]))}this.computeNestedAreas_(i,f);this.numHiddenModels_=this.layoutNestedMap_(a,{width:b.width,height:b.height},i,{x:0,y:0},50);if(g){a={min:Number.MAX_VALUE,max:Number.MIN_VALUE,meta:g,kind:this.project_.metaModel()[g].kind,colorMin:{r:237,g:76,b:95},colorMax:{r:122,g:255,b:115},colorGroup:"transparent"};this.computeColorRange_(i,a);this.colorTree_(i,a)}return this.numHiddenModels_>0};
rhizo.layout.TreeMapLayout.prototype.cleanup=function(){if(this.numHiddenModels_>0){this.project_.resetAllFilter("__treemap__");this.numHiddenModels_=0;return true}return false};rhizo.layout.TreeMapLayout.prototype.dependentModels=function(a){var b=[];if(a=this.globalNodesMap_[a]){a.deepChildsAsArray(b);for(a=b.length-1;a>=0;a--)b[a]=b[a].id}return b};rhizo.layout.TreeMapLayout.prototype.toString=function(){return"TreeMap"};
rhizo.layout.TreeMapLayout.prototype.layoutNestedMap_=function(a,b,c,d,e){var f=0;if(c.numChilds==0)return f;b=this.layoutFlatMap_(a,b,c);for(var g=0;g<b.length;g++){f+=b[g].draw(d,e);for(var h=0;h<b[g].nodes().length;h++){var i=b[g].nodes()[h],j=c.childs[i.id];j.treemapnode=i;f+=this.layoutNestedMap_(a,i.nestedBoundingRect(),j,i.nestedAnchor(),e+1,a)}}return f};rhizo.layout.TreeMapLayout.prototype.sortByAreaDesc_=function(a,b){return b.area-a.area};
rhizo.layout.TreeMapLayout.prototype.layoutFlatMap_=function(a,b,c){var d=[];if(c.numChilds==0)return d;c=c.childsAsArray();for(var e=0,f=0;f<c.length;f++)e+=c[f].area;var g;if(e>0)g=b.width*b.height*1/e;b.width<b.height?d.push(new rhizo.layout.treemap.TreeMapSlice(b.width,rhizo.layout.treemap.TreeMapDirection.HOR,{x:0,y:0})):d.push(new rhizo.layout.treemap.TreeMapSlice(b.height,rhizo.layout.treemap.TreeMapDirection.VER,{x:0,y:0}));e=d[0];f=0;c.sort(this.sortByAreaDesc_);var h=new rhizo.layout.treemap.TreeMapNode(c[f++],
a,this.project_,g);h.area()<=0&&h.hide();for(e.addNode(h);f<c.length;){h=new rhizo.layout.treemap.TreeMapNode(c[f++],a,this.project_,g);if(h.area()<=0)h.hide();else{var i=e.aspectRatio(h),j=e.aspectRatio();if(i>j){b=this.getRemainderBoundingRect_(b,e);i=e.direction()==rhizo.layout.treemap.TreeMapDirection.HOR?b.height:b.width;e=e.direction()==rhizo.layout.treemap.TreeMapDirection.HOR?new rhizo.layout.treemap.TreeMapSlice(i,rhizo.layout.treemap.TreeMapDirection.VER,{x:e.anchorPoint().x,y:e.anchorPoint().y+
e.span()}):new rhizo.layout.treemap.TreeMapSlice(i,rhizo.layout.treemap.TreeMapDirection.HOR,{x:e.anchorPoint().x+e.span(),y:e.anchorPoint().y});d.push(e)}}e.addNode(h)}return d};rhizo.layout.TreeMapLayout.prototype.getRemainderBoundingRect_=function(a,b){var c=b.span();return b.direction()==rhizo.layout.treemap.TreeMapDirection.HOR?{width:a.width,height:a.height-c}:{width:a.width-c,height:a.height}};
rhizo.layout.TreeMapLayout.prototype.computeNestedAreas_=function(a,b){if(a.numChilds==0){a.area=parseFloat(a.payload().unwrap()[b]);if(isNaN(a.area)||a.area<0)a.area=0}else{var c=0;for(var d in a.childs)c+=this.computeNestedAreas_(a.childs[d],b);a.area=c}return a.area};
rhizo.layout.TreeMapLayout.prototype.computeColorRange_=function(a,b){if(!a.is_root&&a.treemapnode.isHidden())return false;if(a.numChilds>0){var c=false;for(var d in a.childs)c=this.computeColorRange_(a.childs[d],b)||c;c||a.is_root||a.treemapnode.updateColorRange(b)}else a.is_root||a.treemapnode.updateColorRange(b);return true};
rhizo.layout.TreeMapLayout.prototype.colorTree_=function(a,b){if(!a.is_root&&a.treemapnode.isHidden())return false;if(a.numChilds>0){var c=false;for(var d in a.childs)c=this.colorTree_(a.childs[d],b)||c;a.is_root||(c?a.treemapnode.color(b.colorGroup):a.treemapnode.colorWeighted(b))}else a.is_root||a.treemapnode.colorWeighted(b);return true};rhizo.layout.TreeMapLayout.prototype.revertExpandedModels_=function(a){for(var b=a.length-1;b>=0;b--)a[b].rendering().setExpanded(false)};
rhizo.layout.TreeMapLayoutUI=function(a,b){this.layout_=a;this.project_=b;this.parentKeySelector_=this.colorSelector_=this.areaSelector_=null;this.parentMatcher_=rhizo.layout.orMatcher(rhizo.layout.linkMatcher,rhizo.layout.hierarchyMatcher)};
rhizo.layout.TreeMapLayoutUI.prototype.renderControls=function(){var a=this.checkParentKeys_(),b=$("<div />");this.areaSelector_=rhizo.layout.metaModelKeySelector(this.project_,"rhizo-treemaplayout-area",rhizo.layout.numericMatcher).change(jQuery.proxy(this.updateState_,this));this.colorSelector_=rhizo.layout.metaModelKeySelector(this.project_,"rhizo-treemaplayout-color",rhizo.layout.numericMatcher).append("<option value=''>-</option>").change(jQuery.proxy(this.updateState_,this));b.append(this.renderSelector_("Area: ",
this.areaSelector_)).append(this.renderSelector_("Color: ",this.colorSelector_));if(a){this.parentKeySelector_=rhizo.layout.metaModelKeySelector(this.project_,"rhizo-treemaplayout-parentKey",this.parentMatcher_).append("<option value=''>-</option>").change(jQuery.proxy(this.updateState_,this));b.append(this.renderSelector_("Group by: ",this.parentKeySelector_))}return b};rhizo.layout.TreeMapLayoutUI.prototype.renderSelector_=function(a,b){return $("<div />",{"class":"rhizo-layout-control"}).append($("<label />").text(a)).append(b)};
rhizo.layout.TreeMapLayoutUI.prototype.checkParentKeys_=function(){for(var a in this.project_.metaModel())if(this.parentMatcher_(a,this.project_.metaModel()[a]))return true;return false};rhizo.layout.TreeMapLayoutUI.prototype.setState=function(a){this.areaSelector_.val(a.area);this.colorSelector_.val(a.color||"");if(this.parentKeySelector_)this.parentKeySelector_.val(a.parentKey||"")};
rhizo.layout.TreeMapLayoutUI.prototype.updateState_=function(){var a={area:this.areaSelector_.val(),color:this.colorSelector_.val()};if(this.parentKeySelector_)a.parentKey=this.parentKeySelector_.val();this.layout_.setStateFromUI(a)};rhizo.layout.layouts.treemap=rhizo.layout.TreeMapLayout;namespace("rhizo.model.loader");rhizo.model.loader.loaders=[];var $globalJSONPLoaderCount=0,$globalJSONPLoaderMap={};
rhizo.model.loader.JSONP=function(a){this.resource_=a;this.loaderCount_=$globalJSONPLoaderCount++;$globalJSONPLoaderMap[this.loaderCount_]=this};rhizo.model.loader.loaders.push(rhizo.model.loader.JSONP);rhizo.model.loader.JSONP.prototype.match=function(){return/\.js$/.test(this.resource_)};
rhizo.model.loader.JSONP.prototype.load=function(a){this.callback_=a;a=document.createElement("script");a.src=this.resource_+"?jsonp=$globalJSONPLoaderMap["+this.loaderCount_+"].loadDone";a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a)};rhizo.model.loader.JSONP.prototype.loadDone=function(a){this.callback_(a.models,a.metamodel,a.renderer);$globalJSONPLoaderMap[this.loaderCount_]=null};rhizo.model.loader.GViz=function(a){this.datasource_url=this.resource_=a};rhizo.model.loader.loaders.push(rhizo.model.loader.GViz);
rhizo.model.loader.GViz.prototype.match=function(){return false};rhizo.model.loader.GViz.prototype.load=function(a,b,c){if(typeof google=="undefined"||typeof google.visualization=="undefined")c.error("Google Visualization APIs not available.");else{var d=this;(new google.visualization.Query(this.resource_)).send(function(e){d.handleQueryResponse_(e,a,b,c)})}};
rhizo.model.loader.GViz.prototype.handleQueryResponse_=function(a,b,c,d){if(a.isError())d.error("GViz load failed: "+a.getMessage());else{a=new rhizo.gviz.Initializer(a.getDataTable(),d,c);a.parse()&&b(a.models,a.metamodel,a.renderer)}};rhizo.model.loader.GoogleSpreadsheets=function(a){rhizo.model.loader.GViz.call(this,a)};rhizo.inherits(rhizo.model.loader.GoogleSpreadsheets,rhizo.model.loader.GViz);rhizo.model.loader.loaders.push(rhizo.model.loader.GoogleSpreadsheets);
rhizo.model.loader.GoogleSpreadsheets.prototype.match=function(){return/spreadsheets\d?\.google\.com/.test(this.resource_)};rhizo.model.loader.GoogleGadget=function(a){rhizo.model.loader.GViz.call(this,a)};rhizo.inherits(rhizo.model.loader.GoogleGadget,rhizo.model.loader.GViz);rhizo.model.loader.loaders.push(rhizo.model.loader.GoogleGadget);rhizo.model.loader.GoogleGadget.prototype.match=function(){return false};
rhizo.model.loader.GoogleGadget.prototype.load=function(a,b,c){if(typeof google=="undefined"||typeof google.visualization=="undefined")c.error("Google Visualization APIs not available.");else if(typeof _IG_Prefs=="undefined")c.error("Google Gadget APIs not available.");else{var d=new _IG_Prefs,e=this;(new google.visualization.GadgetHelper).createQueryFromPrefs(d).send(function(f){e.handleQueryResponse_(f,a,b,c)})}};
rhizo.model.loader.load=function(a,b,c,d){for(var e=rhizo.model.loader.loaders,f=0;f<e.length;f++){var g=new e[f](a);if(g.match()){g.load(b,c,d);return}}d.error("No loader available for the resource: "+a)};namespace("rhizo.broadcast");rhizo.broadcast.BaseComponent=function(a,b){rhizo.ui.component.Component.call(this,a,b,"rhizo.broadcast.BaseComponent");this.specialized_component_=null};rhizo.inherits(rhizo.broadcast.BaseComponent,rhizo.ui.component.Component);
rhizo.broadcast.BaseComponent.prototype.title=function(){return"Broadcast"};
rhizo.broadcast.BaseComponent.prototype.render=function(){var a=$("<div />",{"class":"rhizo-broadcast"});if(!rhizo.broadcast.globalTransmitter()){this.project_.logger().warn("Channels API not loaded. Broadcasting is disabled");return a.get(0)}var b=rhizo.util.urlParams();this.specialized_component_="follow"in b&&b.pid==this.project_.uuid()?new rhizo.broadcast.FollowComponent(this.project_,this.options_,b.follow):new rhizo.broadcast.BroadcastComponent(this.project_,this.options_);a.append(this.specialized_component_.render());
return a.get(0)};rhizo.broadcast.BaseComponent.prototype.metaReady=function(){this.specialized_component_.metaReady()};rhizo.broadcast.BaseComponent.prototype.ready=function(){this.specialized_component_.ready()};rhizo.broadcast.FollowComponent=function(a,b,c){rhizo.ui.component.Component.call(this,a,b);this.followed_channel_uuid_=c;this.following_=false};rhizo.inherits(rhizo.broadcast.FollowComponent,rhizo.ui.component.Component);
rhizo.broadcast.FollowComponent.prototype.render=function(){this.follow_=$("<button />",{disabled:"disabled"}).text("Initializing");this.tip_=$("<p />");return[this.follow_.get(0),this.tip_.get(0)]};rhizo.broadcast.FollowComponent.prototype.ready=function(){this.resumeFollowing_();this.follow_.removeAttr("disabled").click(jQuery.proxy(function(){this.following_?this.stopFollowing_():this.resumeFollowing_()},this))};
rhizo.broadcast.FollowComponent.prototype.resumeFollowing_=function(){this.follow_.text("Wait ...");this.tip_.text("Connecting to the remote visualization...");rhizo.broadcast.globalTransmitter().follow(this.followed_channel_uuid_,true,jQuery.proxy(function(a,b,c){if(a){a=rhizo.state.getMasterOverlord().projectOverlord(this.project_);b=new rhizo.broadcast.FollowStateBinder(a,rhizo.broadcast.globalTransmitter());a.addBinding(b);c&&c.state&&rhizo.state.getMasterOverlord().setInitialState(rhizo.broadcast.BINDER_KEY,
c.state,true);this.follow_.text("Stop");this.tip_.text("You are following a remote visualization.");this.following_=true}else{this.follow_.text("Retry");this.tip_.text(b)}},this))};
rhizo.broadcast.FollowComponent.prototype.stopFollowing_=function(){this.follow_.text("Wait ...");this.tip_.text("Disconnecting from remote visualization...");rhizo.broadcast.globalTransmitter().follow(this.followed_channel_uuid_,false,jQuery.proxy(function(a,b){if(a){rhizo.state.getMasterOverlord().projectOverlord(this.project_).removeBinding(rhizo.broadcast.BINDER_KEY).unlisten();this.follow_.text("Resume");this.tip_.text("Resume following the visualization.");this.following_=false}else{this.follow_.text("Retry");
this.tip_.text(b)}},this))};rhizo.broadcast.BroadcastComponent=function(a,b){rhizo.ui.component.Component.call(this,a,b);this.broadcasting_=false};rhizo.inherits(rhizo.broadcast.BroadcastComponent,rhizo.ui.component.Component);
rhizo.broadcast.BroadcastComponent.prototype.render=function(){this.share_=$("<button />",{disabled:"disabled"}).text("Broadcast");this.tip_=$("<p />").text("Let others follow this visualization.");this.shareUrl_=$("<input />",{type:"text","class":"rhizo-broadcast-url"});return[this.share_.get(0),this.tip_.get(0),this.shareUrl_.get(0)]};
rhizo.broadcast.BroadcastComponent.prototype.ready=function(){this.share_.removeAttr("disabled").click(jQuery.proxy(function(){this.broadcasting_?this.stopBroadcasting_():this.startBroadcasting_()},this))};
rhizo.broadcast.BroadcastComponent.prototype.startBroadcasting_=function(){this.share_.text("Wait ...");rhizo.broadcast.globalTransmitter().open(jQuery.proxy(function(a,b){if(a){var c=rhizo.state.getMasterOverlord().projectOverlord(this.project_),d=new rhizo.broadcast.BroadcastStateBinder(c,rhizo.broadcast.globalTransmitter());c.addBinding(d);this.tip_.text("Share this URL for others to join.");this.share_.text("Stop");this.shareUrl_.val(rhizo.util.buildUrl(null,{follow:b,pid:this.project_.uuid()})).show("fast").focus().select();
this.broadcasting_=true}else{this.tip_.text(b);this.share_.text("Broadcast")}},this))};rhizo.broadcast.BroadcastComponent.prototype.stopBroadcasting_=function(){rhizo.state.getMasterOverlord().projectOverlord(this.project_).removeBinding(rhizo.broadcast.BINDER_KEY);this.tip_.text("Let others follow this visualization.");this.share_.text("Broadcast");this.shareUrl_.hide().val("");this.broadcasting_=false};rhizo.broadcast.BINDER_KEY="broadcast";
rhizo.broadcast.FollowStateBinder=function(a,b){rhizo.state.StateBinder.call(this,a,rhizo.broadcast.BINDER_KEY);this.transmitter_=b;this.transmitter_.listen("__binder__",jQuery.proxy(function(c){this.stateReceived_(c)},this))};rhizo.inherits(rhizo.broadcast.FollowStateBinder,rhizo.state.StateBinder);rhizo.broadcast.FollowStateBinder.prototype.stateReceived_=function(a){this.overlord_.transition(this.key(),a.delta,a.state,a.replace)};rhizo.broadcast.FollowStateBinder.prototype.unlisten=function(){this.transmitter_.unlisten("__binder__")};
rhizo.broadcast.FollowStateBinder.prototype.onTransition=function(){};rhizo.broadcast.BroadcastStateBinder=function(a,b){rhizo.state.StateBinder.call(this,a,rhizo.broadcast.BINDER_KEY);this.transmitter_=b};rhizo.inherits(rhizo.broadcast.BroadcastStateBinder,rhizo.state.StateBinder);rhizo.broadcast.BroadcastStateBinder.prototype.onTransition=function(a,b,c){this.transmitter_.publish({delta:a,state:b,replace:c||false})};
rhizo.broadcast.Transmitter=function(){this.channel_uuid_=this.socket_=this.channel_=null;this.listen_callbacks_={}};rhizo.broadcast.Transmitter.prototype.listen=function(a,b){this.listen_callbacks_[a]=b};rhizo.broadcast.Transmitter.prototype.unlisten=function(a){delete this.listen_callbacks_[a]};
rhizo.broadcast.Transmitter.prototype.follow=function(a,b,c){this.channel_uuid_?$.ajax({url:"/broadcast/follow",dataType:"json",type:"POST",data:{uuid:this.channel_uuid_,follow:a,enable:b?"1":"0"},error:function(){c(false,"Error changing follow status")},success:function(d){if(d.status!="ok")c(false,"Error changing follow status: "+d.status);else b?c(true,null,JSON.parse(d.initial)):c(true)}}):this.open(jQuery.proxy(function(d,e){d?this.follow(a,b,c):c(d,e)},this))};
rhizo.broadcast.Transmitter.prototype.publish=function(a,b){if(this.channel_uuid_)$.ajax({url:"/broadcast/publish",dataType:"json",type:"POST",data:{uuid:this.channel_uuid_,payload:JSON.stringify(a)},error:function(){b&&b(false,"Error publishing message")},success:function(c){if(c.status!="ok")b&&b(false,"Error publishing message: "+c.status);else b&&b(true)}});else b&&b(false,"Channel is not established yet.")};
rhizo.broadcast.Transmitter.prototype.open=function(a){this.channel_uuid_?a(true,this.channel_uuid_):$.ajax({url:"/broadcast/open",dataType:"json",type:"POST",error:function(){a(false,"Error opening channel.")},success:jQuery.proxy(function(b){b.status!="ok"?a(false,"Error opening channel: "+b.status):this.openChannel_(b.channel_token,b.channel_uuid,a)},this)})};rhizo.broadcast.Transmitter.prototype.messageReceived_=function(a){a=JSON.parse(a.data);for(var b in this.listen_callbacks_)this.listen_callbacks_[b](a)};
rhizo.broadcast.Transmitter.prototype.openChannel_=function(a,b,c){this.channel_=new goog.appengine.Channel(a);this.socket_=this.channel_.open();this.socket_.onopen=jQuery.proxy(function(){this.confirmOpenChannel_(b,c)},this);this.socket_.onmessage=jQuery.proxy(this.messageReceived_,this)};
rhizo.broadcast.Transmitter.prototype.confirmOpenChannel_=function(a,b){$.ajax({url:"/broadcast/connect",dataType:"json",data:{uuid:a},type:"POST",error:function(){b(false,"Error confirming channel opening.")},success:jQuery.proxy(function(c){if(c.status!="ok")b(false,"Error confirming channel opening: "+c.status);else{this.channel_uuid_=a;b(true,a)}},this)})};rhizo.broadcast.transmitter_=null;
if(typeof goog!="undefined"&&typeof goog.appengine!="undefined"&&typeof goog.appengine.Channel!="undefined")rhizo.broadcast.transmitter_=new rhizo.broadcast.Transmitter;rhizo.broadcast.globalTransmitter=function(){return rhizo.broadcast.transmitter_};namespace("rhizo.ui.gui");
rhizo.ui.gui.GUI=function(a,b,c){this.platform_=b;this.device_=c;this.container=$(a);this.is_small_container_=false;this.initContainer_();this.viewport=this.universe=null;this.componentsMap_={};this.selectionModeOn_=this.noFx=false};rhizo.ui.gui.GUI.prototype.done=function(){var a=rhizo.util.urlParams().kb;a&&/true|yes|1/.test(a)&&this.activateOnscreenKeyboard()};
rhizo.ui.gui.GUI.prototype.destroy=function(){for(var a=this.container.get(0).className.split(" "),b=0;b<a.length;b++)a[b].indexOf("rhizo")==0&&this.container.removeClass(a[b]);this.container.children().remove()};rhizo.ui.gui.GUI.prototype.initContainer_=function(){this.container.addClass("rhizo").addClass("rhizo-device-"+this.device_).addClass("rhizo-platform-"+this.platform_);this.is_small_container_=this.container.width()<600||this.container.height()<250};
rhizo.ui.gui.GUI.prototype.setViewport=function(a){this.viewport=a};rhizo.ui.gui.GUI.prototype.setUniverse=function(a){this.universe=a};rhizo.ui.gui.GUI.prototype.addComponent=function(a,b){this.componentsMap_[a]=b};rhizo.ui.gui.GUI.prototype.getComponent=function(a){return this.componentsMap_[a]};rhizo.ui.gui.GUI.prototype.isSmall=function(){return this.is_small_container_};rhizo.ui.gui.GUI.prototype.isMobile=function(){return this.platform_=="mobile"};
rhizo.ui.gui.GUI.prototype.allRenderingHints=function(){return{small:this.isSmall(),mobile:this.isMobile()}};rhizo.ui.gui.GUI.prototype.isSelectionModeOn=function(){return this.selectionModeOn_};
rhizo.ui.gui.GUI.prototype.toggleSelectionMode=function(){var a=(this.selectionModeOn_=!this.selectionModeOn_)?"disable":"enable";this.viewport.selectable(this.selectionModeOn_?"enable":"disable").draggable(a).toggleClass("rhizo-selection-mode");(a=this.getComponent("rhizo.ui.component.BottomBar"))&&a.toggleComponent("rhizo.ui.component.SelectionManager",this.selectionModeOn_);(a=this.getComponent("rhizo.ui.component.SelectionManager"))&&a.toggleSelectionTrigger(this.selectionModeOn_)};
rhizo.ui.gui.GUI.prototype.disableFx=function(a){this.noFx=a};rhizo.ui.gui.GUI.prototype.activateOnscreenKeyboard=function(){rhizo.keyboard&&rhizo.keyboard.Keyboard&&new rhizo.keyboard.Keyboard(this.container)};namespace("rhizo.bootstrap");rhizo.bootstrap.uuids_=0;
rhizo.bootstrap.Bootstrap=function(a,b,c){this.container_=a;this.deployed_=false;var d=$(a).attr("id");if(!d||d.length==0)$(a).attr("id","rhizo-uuid-"+rhizo.bootstrap.uuids_++);this.options_={selectfilter:".rhizo-model:visible",enableHTML5History:true,enableAnims:true};b&&$.extend(this.options_,b);this.ready_callback_=c};rhizo.bootstrap.Bootstrap.prototype.isDeployed=function(){return this.deployed_};
rhizo.bootstrap.Bootstrap.prototype.prepareAndDeploy=function(a){var b=this.prepare();this.deploy(a);return b};rhizo.bootstrap.Bootstrap.prototype.prepare=function(){this.gui_=this.initGui_();this.project_=new rhizo.Project(this.gui_,this.options_);this.template_=this.initTemplate_(this.project_,this.gui_,this.options_);this.project_.chromeReady();return this.project_};
rhizo.bootstrap.Bootstrap.prototype.deploy=function(a){(a=a||this.tryInitResourceFromUrl_())&&rhizo.model.loader.load(a,jQuery.proxy(this.deployExplicit,this),this.options_,this.project_.logger())};rhizo.bootstrap.Bootstrap.prototype.deployWithLoader=function(a){a.load(jQuery.proxy(this.deployExplicit,this),this.options_,this.project_.logger())};
rhizo.bootstrap.Bootstrap.prototype.deployExplicit=function(a,b,c){b=this.options_.metamodel||b;this.options_.metamodelFragment&&$.extend(b,this.options_.metamodelFragment);this.project_.setMetaModel(b);this.project_.setRenderer(this.options_.renderer||c);if(this.project_.renderer().getSizeRange||this.project_.renderer().getColorRange)this.template_.addComponent(new rhizo.ui.component.Legend(this.project_,this.options_));if(this.project_.metaReady()){this.template_.metaReady();this.project_.deploy(a);
this.template_.ready()}this.gui_.done();this.ready_callback_&&this.ready_callback_(this.project_);this.deployed_=true};
rhizo.bootstrap.Bootstrap.prototype.identifyPlatformAndDevice_=function(){if(this.options_.platform&&this.options_.device)return{platform:this.options_.platform,device:this.options_.device};var a=navigator.userAgent;if(a.toLowerCase().indexOf("ipad")!=-1)return{platform:"mobile",device:"ipad"};else if(a.toLowerCase().indexOf("iphone")!=-1)return{platform:"mobile",device:"iphone"};else if(a.toLowerCase().indexOf("android")!=-1)return{platform:"mobile",device:"android"};return{platform:"default",device:"default"}};
rhizo.bootstrap.Bootstrap.prototype.identifyTemplate_=function(a,b){if(b.template&&b.template in rhizo.ui.component.templates)return rhizo.ui.component.templates[b.template];if(a.isMobile()||a.isSmall())return rhizo.ui.component.templates.bottom;return rhizo.ui.component.templates["default"]};
rhizo.bootstrap.Bootstrap.prototype.initGui_=function(){var a=this.identifyPlatformAndDevice_();a=new rhizo.ui.gui.GUI(this.container_,a.platform,a.device);a.disableFx(!this.options_.enableAnims);rhizo.jquery.init(a,this.options_.enableAnims,true);return a};rhizo.bootstrap.Bootstrap.prototype.initTemplate_=function(a,b,c){a=this.identifyTemplate_(b,c)(a,c);a.render();return a};
rhizo.bootstrap.Bootstrap.prototype.tryInitResourceFromUrl_=function(){if(!this.options_.allowConfigFromUrl){this.project_.logger().warn("Sources extraction from url is disabled");return null}var a=rhizo.util.urlParams();a=a.source||a.src;if(!a){this.project_.logger().error("Unable to identify datasource from location");return null}return decodeURIComponent(a)};
